<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pool League Manager - Super Admin</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #1e1b4b 0%, #312e81 50%, #4c1d95 100%);
        }
        .stat-card {
            transition: all 0.3s ease;
        }
        .stat-card:hover {
            transform: translateY(-2px);
        }
    </style>
</head>
<body class="bg-slate-100 min-h-screen">
    <div id="app">
        <!-- Login Screen -->
        <div id="login-screen" class="min-h-screen gradient-bg flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
                <div class="text-center mb-8">
                    <div class="text-5xl mb-4">üõ°Ô∏è</div>
                    <h1 class="text-3xl font-black text-slate-800">Super Admin</h1>
                    <p class="text-slate-600">Pool League Manager</p>
                </div>
                <div class="space-y-4">
                    <input type="password" id="admin-password" placeholder="Admin Password" 
                        class="w-full px-4 py-3 border-2 border-slate-300 rounded-lg focus:border-purple-500 focus:outline-none">
                    <div id="login-error" class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg text-sm"></div>
                    <button onclick="login()" class="w-full py-4 bg-purple-600 text-white font-bold rounded-xl hover:bg-purple-700">
                        Access Dashboard
                    </button>
                </div>
            </div>
        </div>

        <!-- Dashboard -->
        <div id="dashboard" class="hidden">
            <!-- Header -->
            <header class="gradient-bg text-white py-6 px-4 shadow-lg">
                <div class="max-w-7xl mx-auto flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <span class="text-3xl">üõ°Ô∏è</span>
                        <div>
                            <h1 class="text-2xl font-black">Super Admin Dashboard</h1>
                            <p class="text-purple-200 text-sm">Pool League Manager</p>
                        </div>
                    </div>
                    <button onclick="logout()" class="px-4 py-2 bg-white/20 hover:bg-white/30 rounded-lg font-semibold">
                        Logout
                    </button>
                </div>
            </header>

            <!-- Navigation -->
            <nav class="bg-white shadow-md border-b">
                <div class="max-w-7xl mx-auto px-4 flex gap-1">
                    <button onclick="showTab('overview')" id="tab-overview" class="tab-btn px-6 py-4 font-semibold border-b-4 border-purple-600 text-purple-700">
                        üìä Overview
                    </button>
                    <button onclick="showTab('organizations')" id="tab-organizations" class="tab-btn px-6 py-4 font-semibold border-b-4 border-transparent text-slate-600 hover:text-purple-600">
                        üè¢ Organizations
                    </button>
                    <button onclick="showTab('users')" id="tab-users" class="tab-btn px-6 py-4 font-semibold border-b-4 border-transparent text-slate-600 hover:text-purple-600">
                        üë• All Users
                    </button>
                    <button onclick="showTab('subscriptions')" id="tab-subscriptions" class="tab-btn px-6 py-4 font-semibold border-b-4 border-transparent text-slate-600 hover:text-purple-600">
                        üí≥ Subscriptions
                    </button>
                </div>
            </nav>

            <!-- Main Content -->
            <main class="max-w-7xl mx-auto px-4 py-8">
                <!-- Overview Tab -->
                <div id="content-overview" class="tab-content">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        <div class="stat-card bg-white rounded-xl shadow-lg p-6">
                            <div class="flex items-center gap-4">
                                <div class="text-4xl">üè¢</div>
                                <div>
                                    <div id="stat-orgs" class="text-3xl font-black text-slate-800">-</div>
                                    <div class="text-slate-600">Organizations</div>
                                </div>
                            </div>
                        </div>
                        <div class="stat-card bg-white rounded-xl shadow-lg p-6">
                            <div class="flex items-center gap-4">
                                <div class="text-4xl">üë•</div>
                                <div>
                                    <div id="stat-users" class="text-3xl font-black text-slate-800">-</div>
                                    <div class="text-slate-600">Total Users</div>
                                </div>
                            </div>
                        </div>
                        <div class="stat-card bg-white rounded-xl shadow-lg p-6">
                            <div class="flex items-center gap-4">
                                <div class="text-4xl">‚úÖ</div>
                                <div>
                                    <div id="stat-active" class="text-3xl font-black text-emerald-600">-</div>
                                    <div class="text-slate-600">Active Subs</div>
                                </div>
                            </div>
                        </div>
                        <div class="stat-card bg-white rounded-xl shadow-lg p-6">
                            <div class="flex items-center gap-4">
                                <div class="text-4xl">‚è∞</div>
                                <div>
                                    <div id="stat-trial" class="text-3xl font-black text-yellow-600">-</div>
                                    <div class="text-slate-600">On Trial</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h2 class="text-xl font-bold mb-4">üìà Recent Activity</h2>
                        <div id="recent-activity" class="space-y-3">
                            <p class="text-slate-500">Loading...</p>
                        </div>
                    </div>
                </div>

                <!-- Organizations Tab -->
                <div id="content-organizations" class="tab-content hidden">
                    <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                        <div class="flex items-center gap-4 mb-4">
                            <input type="text" id="search-orgs" placeholder="Search organizations..." 
                                class="flex-1 px-4 py-2 border-2 rounded-lg" onkeyup="filterOrgs()">
                            <select id="filter-status" class="px-4 py-2 border-2 rounded-lg" onchange="filterOrgs()">
                                <option value="">All Status</option>
                                <option value="active">Active</option>
                                <option value="trial">Trial</option>
                                <option value="canceled">Canceled</option>
                            </select>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                        <table class="w-full">
                            <thead class="bg-slate-100">
                                <tr>
                                    <th class="px-4 py-3 text-left text-sm font-bold">Organization</th>
                                    <th class="px-4 py-3 text-left text-sm font-bold">Owner</th>
                                    <th class="px-4 py-3 text-left text-sm font-bold">Status</th>
                                    <th class="px-4 py-3 text-left text-sm font-bold">Tier</th>
                                    <th class="px-4 py-3 text-left text-sm font-bold">Users</th>
                                    <th class="px-4 py-3 text-left text-sm font-bold">Teams</th>
                                    <th class="px-4 py-3 text-left text-sm font-bold">Created</th>
                                    <th class="px-4 py-3 text-left text-sm font-bold">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="orgs-table" class="divide-y">
                                <tr><td colspan="8" class="px-4 py-8 text-center text-slate-500">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Users Tab -->
                <div id="content-users" class="tab-content hidden">
                    <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                        <div class="flex items-center gap-4">
                            <input type="text" id="search-users" placeholder="Search users by name, email, or phone..." 
                                class="flex-1 px-4 py-2 border-2 rounded-lg" onkeyup="filterUsers()">
                            <select id="filter-role" class="px-4 py-2 border-2 rounded-lg" onchange="filterUsers()">
                                <option value="">All Roles</option>
                                <option value="admin">Admin</option>
                                <option value="captain">Captain</option>
                                <option value="player">Player</option>
                            </select>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                        <table class="w-full">
                            <thead class="bg-slate-100">
                                <tr>
                                    <th class="px-4 py-3 text-left text-sm font-bold">User</th>
                                    <th class="px-4 py-3 text-left text-sm font-bold">Organization</th>
                                    <th class="px-4 py-3 text-left text-sm font-bold">Role</th>
                                    <th class="px-4 py-3 text-left text-sm font-bold">Phone</th>
                                    <th class="px-4 py-3 text-left text-sm font-bold">Created</th>
                                    <th class="px-4 py-3 text-left text-sm font-bold">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="users-table" class="divide-y">
                                <tr><td colspan="6" class="px-4 py-8 text-center text-slate-500">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Subscriptions Tab -->
                <div id="content-subscriptions" class="tab-content hidden">
                    <div class="grid md:grid-cols-3 gap-6 mb-6">
                        <div class="bg-emerald-50 border-2 border-emerald-200 rounded-xl p-6">
                            <h3 class="font-bold text-emerald-800 mb-2">üí∞ Monthly Revenue</h3>
                            <div id="stat-revenue" class="text-3xl font-black text-emerald-600">$0</div>
                        </div>
                        <div class="bg-blue-50 border-2 border-blue-200 rounded-xl p-6">
                            <h3 class="font-bold text-blue-800 mb-2">üìä Starter Plans</h3>
                            <div id="stat-starter" class="text-3xl font-black text-blue-600">0</div>
                        </div>
                        <div class="bg-purple-50 border-2 border-purple-200 rounded-xl p-6">
                            <h3 class="font-bold text-purple-800 mb-2">‚≠ê Pro Plans</h3>
                            <div id="stat-pro" class="text-3xl font-black text-purple-600">0</div>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                        <table class="w-full">
                            <thead class="bg-slate-100">
                                <tr>
                                    <th class="px-4 py-3 text-left text-sm font-bold">Organization</th>
                                    <th class="px-4 py-3 text-left text-sm font-bold">Status</th>
                                    <th class="px-4 py-3 text-left text-sm font-bold">Tier</th>
                                    <th class="px-4 py-3 text-left text-sm font-bold">Billing</th>
                                    <th class="px-4 py-3 text-left text-sm font-bold">Trial Ends</th>
                                    <th class="px-4 py-3 text-left text-sm font-bold">Stripe Customer</th>
                                    <th class="px-4 py-3 text-left text-sm font-bold">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="subs-table" class="divide-y">
                                <tr><td colspan="7" class="px-4 py-8 text-center text-slate-500">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </main>
        </div>

        <!-- Reset Password Modal -->
        <div id="reset-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
            <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md mx-4">
                <h2 class="text-2xl font-bold mb-4">üîê Reset Password</h2>
                <div id="reset-user-info" class="bg-slate-50 p-4 rounded-lg mb-4"></div>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-semibold mb-1">New Password</label>
                        <input type="text" id="new-password" placeholder="Enter new password" 
                            class="w-full px-4 py-3 border-2 rounded-lg">
                    </div>
                    <div class="flex gap-3">
                        <button onclick="generatePassword()" class="px-4 py-2 bg-slate-200 rounded-lg font-semibold hover:bg-slate-300">
                            üé≤ Generate
                        </button>
                        <button onclick="confirmResetPassword()" class="flex-1 py-3 bg-purple-600 text-white font-bold rounded-lg hover:bg-purple-700">
                            Reset Password
                        </button>
                    </div>
                    <button onclick="closeResetModal()" class="w-full py-2 text-slate-600 hover:text-slate-800">
                        Cancel
                    </button>
                </div>
            </div>
        </div>

        <!-- Org Details Modal -->
        <div id="org-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 overflow-y-auto">
            <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-4xl mx-4 my-8">
                <div class="flex justify-between items-start mb-6">
                    <h2 class="text-2xl font-bold">üè¢ Organization Details</h2>
                    <button onclick="closeOrgModal()" class="text-slate-400 hover:text-slate-600 text-2xl">&times;</button>
                </div>
                <div id="org-details-content">Loading...</div>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // CONFIGURATION
        // ============================================
        const SUPABASE_URL = 'https://hprdhlletatixqysqegi.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhwcmRobGxldGF0aXhxeXNxZWdpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgwOTU1NDMsImV4cCI6MjA4MzY3MTU0M30._wrv6ONjG3JRkpA1FDPFkKMSn0bi6vhMiR0UZB40IRk';
        
        // CHANGE THIS to your own secure password!
        const SUPER_ADMIN_PASSWORD = 'PoolLeagueAdmin2025!';
        
        const db = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // State
        let organizations = [];
        let users = [];
        let selectedUserId = null;

        // ============================================
        // AUTH
        // ============================================
        function login() {
            const password = document.getElementById('admin-password').value;
            if (password === SUPER_ADMIN_PASSWORD) {
                sessionStorage.setItem('super_admin', 'true');
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('dashboard').classList.remove('hidden');
                loadAllData();
            } else {
                document.getElementById('login-error').textContent = 'Invalid password';
                document.getElementById('login-error').classList.remove('hidden');
            }
        }

        function logout() {
            sessionStorage.removeItem('super_admin');
            location.reload();
        }

        function checkAuth() {
            if (sessionStorage.getItem('super_admin') === 'true') {
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('dashboard').classList.remove('hidden');
                loadAllData();
            }
        }

        // ============================================
        // DATA LOADING
        // ============================================
        async function loadAllData() {
            await Promise.all([
                loadOrganizations(),
                loadUsers()
            ]);
            updateStats();
            updateRecentActivity();
        }

        async function loadOrganizations() {
            const { data, error } = await db.from('organizations').select('*').order('created_at', { ascending: false });
            if (data) {
                organizations = data;
                renderOrgsTable();
                renderSubsTable();
            }
        }

        async function loadUsers() {
            const { data, error } = await db.from('users').select('*').order('created_at', { ascending: false });
            if (data) {
                users = data;
                renderUsersTable();
            }
        }

        // ============================================
        // STATS
        // ============================================
        function updateStats() {
            document.getElementById('stat-orgs').textContent = organizations.length;
            document.getElementById('stat-users').textContent = users.length;
            
            const active = organizations.filter(o => o.subscription_status === 'active').length;
            const trial = organizations.filter(o => o.subscription_status === 'trial').length;
            
            document.getElementById('stat-active').textContent = active;
            document.getElementById('stat-trial').textContent = trial;

            // Revenue calculation
            const starter = organizations.filter(o => o.subscription_status === 'active' && o.subscription_tier === 'starter').length;
            const pro = organizations.filter(o => o.subscription_status === 'active' && o.subscription_tier === 'pro').length;
            const revenue = (starter * 19) + (pro * 39);
            
            document.getElementById('stat-revenue').textContent = '$' + revenue;
            document.getElementById('stat-starter').textContent = starter;
            document.getElementById('stat-pro').textContent = pro;
        }

        function updateRecentActivity() {
            const recent = [...organizations]
                .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))
                .slice(0, 5);
            
            const html = recent.map(org => {
                const date = new Date(org.created_at).toLocaleDateString();
                return `
                    <div class="flex items-center justify-between p-3 bg-slate-50 rounded-lg">
                        <div>
                            <span class="font-semibold">${org.name}</span>
                            <span class="text-slate-500 text-sm ml-2">signed up</span>
                        </div>
                        <span class="text-slate-500 text-sm">${date}</span>
                    </div>
                `;
            }).join('');
            
            document.getElementById('recent-activity').innerHTML = html || '<p class="text-slate-500">No recent activity</p>';
        }

        // ============================================
        // TABLES
        // ============================================
        function renderOrgsTable() {
            const search = document.getElementById('search-orgs')?.value?.toLowerCase() || '';
            const status = document.getElementById('filter-status')?.value || '';
            
            let filtered = organizations;
            if (search) {
                filtered = filtered.filter(o => o.name.toLowerCase().includes(search));
            }
            if (status) {
                filtered = filtered.filter(o => o.subscription_status === status);
            }

            const html = filtered.map(org => {
                const owner = users.find(u => u.id === org.owner_id);
                const orgUsers = users.filter(u => u.org_id === org.id).length;
                const date = new Date(org.created_at).toLocaleDateString();
                
                const statusBadge = {
                    'active': '<span class="px-2 py-1 bg-emerald-100 text-emerald-800 rounded-full text-xs font-bold">Active</span>',
                    'trial': '<span class="px-2 py-1 bg-yellow-100 text-yellow-800 rounded-full text-xs font-bold">Trial</span>',
                    'canceled': '<span class="px-2 py-1 bg-red-100 text-red-800 rounded-full text-xs font-bold">Canceled</span>',
                    'past_due': '<span class="px-2 py-1 bg-orange-100 text-orange-800 rounded-full text-xs font-bold">Past Due</span>'
                }[org.subscription_status] || '<span class="px-2 py-1 bg-slate-100 text-slate-800 rounded-full text-xs">Unknown</span>';

                return `
                    <tr class="hover:bg-slate-50">
                        <td class="px-4 py-3">
                            <div class="font-semibold">${org.name}</div>
                            <div class="text-xs text-slate-500">${org.slug}</div>
                        </td>
                        <td class="px-4 py-3 text-sm">${owner?.username || '-'}</td>
                        <td class="px-4 py-3">${statusBadge}</td>
                        <td class="px-4 py-3 text-sm capitalize">${org.subscription_tier || '-'}</td>
                        <td class="px-4 py-3 text-sm">${orgUsers}</td>
                        <td class="px-4 py-3 text-sm">-</td>
                        <td class="px-4 py-3 text-sm">${date}</td>
                        <td class="px-4 py-3">
                            <button onclick="viewOrg('${org.id}')" class="text-purple-600 hover:text-purple-800 text-sm font-semibold mr-2">
                                Details
                            </button>
                            <button onclick="viewAsOrgAdmin('${org.id}')" class="text-emerald-600 hover:text-emerald-800 text-sm font-semibold">
                                üëÅÔ∏è View As
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');

            document.getElementById('orgs-table').innerHTML = html || '<tr><td colspan="8" class="px-4 py-8 text-center text-slate-500">No organizations found</td></tr>';
        }

        function renderUsersTable() {
            const search = document.getElementById('search-users')?.value?.toLowerCase() || '';
            const role = document.getElementById('filter-role')?.value || '';
            
            let filtered = users;
            if (search) {
                filtered = filtered.filter(u => 
                    u.username?.toLowerCase().includes(search) || 
                    u.phone?.includes(search)
                );
            }
            if (role) {
                filtered = filtered.filter(u => u.role === role);
            }

            const html = filtered.map(user => {
                const org = organizations.find(o => o.id === user.org_id);
                const date = new Date(user.created_at).toLocaleDateString();
                
                const roleBadge = {
                    'admin': '<span class="px-2 py-1 bg-purple-100 text-purple-800 rounded-full text-xs font-bold">Admin</span>',
                    'captain': '<span class="px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-xs font-bold">Captain</span>',
                    'player': '<span class="px-2 py-1 bg-slate-100 text-slate-800 rounded-full text-xs font-bold">Player</span>'
                }[user.role] || '<span class="px-2 py-1 bg-slate-100 text-slate-800 rounded-full text-xs">Unknown</span>';

                return `
                    <tr class="hover:bg-slate-50">
                        <td class="px-4 py-3">
                            <div class="font-semibold">${user.username}</div>
                            <div class="text-xs text-slate-500">${user.id.slice(0, 8)}...</div>
                        </td>
                        <td class="px-4 py-3 text-sm">${org?.name || '-'}</td>
                        <td class="px-4 py-3">${roleBadge}</td>
                        <td class="px-4 py-3 text-sm">${user.phone || '-'}</td>
                        <td class="px-4 py-3 text-sm">${date}</td>
                        <td class="px-4 py-3">
                            <button onclick="openResetModal('${user.id}')" class="text-purple-600 hover:text-purple-800 text-sm font-semibold mr-2">
                                Reset PW
                            </button>
                            ${user.role === 'admin' ? `<button onclick="impersonateUser('${user.id}')" class="text-emerald-600 hover:text-emerald-800 text-sm font-semibold">üëÅÔ∏è View As</button>` : ''}
                        </td>
                    </tr>
                `;
            }).join('');

            document.getElementById('users-table').innerHTML = html || '<tr><td colspan="6" class="px-4 py-8 text-center text-slate-500">No users found</td></tr>';
        }

        function renderSubsTable() {
            const html = organizations.map(org => {
                const trialEnds = org.trial_ends_at ? new Date(org.trial_ends_at).toLocaleDateString() : '-';
                
                const statusBadge = {
                    'active': '<span class="px-2 py-1 bg-emerald-100 text-emerald-800 rounded-full text-xs font-bold">Active</span>',
                    'trial': '<span class="px-2 py-1 bg-yellow-100 text-yellow-800 rounded-full text-xs font-bold">Trial</span>',
                    'canceled': '<span class="px-2 py-1 bg-red-100 text-red-800 rounded-full text-xs font-bold">Canceled</span>',
                    'past_due': '<span class="px-2 py-1 bg-orange-100 text-orange-800 rounded-full text-xs font-bold">Past Due</span>'
                }[org.subscription_status] || '<span class="px-2 py-1 bg-slate-100 text-slate-800 rounded-full text-xs">Unknown</span>';

                return `
                    <tr class="hover:bg-slate-50">
                        <td class="px-4 py-3 font-semibold">${org.name}</td>
                        <td class="px-4 py-3">${statusBadge}</td>
                        <td class="px-4 py-3 text-sm capitalize">${org.subscription_tier || '-'}</td>
                        <td class="px-4 py-3 text-sm capitalize">${org.billing_interval || '-'}</td>
                        <td class="px-4 py-3 text-sm">${trialEnds}</td>
                        <td class="px-4 py-3 text-sm">
                            ${org.stripe_customer_id ? 
                                `<a href="https://dashboard.stripe.com/test/customers/${org.stripe_customer_id}" target="_blank" class="text-purple-600 hover:underline">${org.stripe_customer_id.slice(0, 14)}...</a>` : 
                                '-'}
                        </td>
                        <td class="px-4 py-3">
                            <button onclick="manualActivate('${org.id}')" class="text-emerald-600 hover:text-emerald-800 text-sm font-semibold mr-2">
                                Activate
                            </button>
                            <button onclick="manualCancel('${org.id}')" class="text-red-600 hover:text-red-800 text-sm font-semibold">
                                Cancel
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');

            document.getElementById('subs-table').innerHTML = html || '<tr><td colspan="7" class="px-4 py-8 text-center text-slate-500">No subscriptions found</td></tr>';
        }

        function filterOrgs() {
            renderOrgsTable();
        }

        function filterUsers() {
            renderUsersTable();
        }

        // ============================================
        // TABS
        // ============================================
        function showTab(tab) {
            // Hide all content
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            // Remove active state from all tabs
            document.querySelectorAll('.tab-btn').forEach(el => {
                el.classList.remove('border-purple-600', 'text-purple-700');
                el.classList.add('border-transparent', 'text-slate-600');
            });
            
            // Show selected content
            document.getElementById('content-' + tab).classList.remove('hidden');
            // Activate selected tab
            const tabBtn = document.getElementById('tab-' + tab);
            tabBtn.classList.add('border-purple-600', 'text-purple-700');
            tabBtn.classList.remove('border-transparent', 'text-slate-600');
        }

        // ============================================
        // PASSWORD RESET
        // ============================================
        function openResetModal(userId) {
            selectedUserId = userId;
            const user = users.find(u => u.id === userId);
            const org = organizations.find(o => o.id === user.org_id);
            
            document.getElementById('reset-user-info').innerHTML = `
                <div><strong>User:</strong> ${user.username}</div>
                <div><strong>Role:</strong> ${user.role}</div>
                <div><strong>Organization:</strong> ${org?.name || '-'}</div>
            `;
            document.getElementById('new-password').value = '';
            document.getElementById('reset-modal').classList.remove('hidden');
        }

        function closeResetModal() {
            selectedUserId = null;
            document.getElementById('reset-modal').classList.add('hidden');
        }

        function generatePassword() {
            const chars = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let password = '';
            for (let i = 0; i < 10; i++) {
                password += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            document.getElementById('new-password').value = password;
        }

        async function confirmResetPassword() {
            const newPassword = document.getElementById('new-password').value;
            if (!newPassword || newPassword.length < 4) {
                alert('Password must be at least 4 characters');
                return;
            }

            const { error } = await db.from('users')
                .update({ password: newPassword })
                .eq('id', selectedUserId);

            if (error) {
                alert('Error resetting password: ' + error.message);
            } else {
                const user = users.find(u => u.id === selectedUserId);
                alert(`Password reset successfully!\n\nUsername: ${user.username}\nNew Password: ${newPassword}`);
                closeResetModal();
            }
        }

        // ============================================
        // ORG DETAILS
        // ============================================
        async function viewOrg(orgId) {
            const org = organizations.find(o => o.id === orgId);
            const orgUsers = users.filter(u => u.org_id === orgId);
            const owner = users.find(u => u.id === org.owner_id);

            // Load teams for this org
            const { data: teams } = await db.from('teams').select('*').eq('org_id', orgId);
            const { data: seasons } = await db.from('seasons').select('*').eq('org_id', orgId);

            document.getElementById('org-details-content').innerHTML = `
                <div class="grid md:grid-cols-2 gap-6 mb-6">
                    <div class="bg-slate-50 p-4 rounded-lg">
                        <h3 class="font-bold mb-3">üìã Organization Info</h3>
                        <div class="space-y-2 text-sm">
                            <div><strong>Name:</strong> ${org.name}</div>
                            <div><strong>Slug:</strong> ${org.slug}</div>
                            <div><strong>Owner:</strong> ${owner?.username || '-'}</div>
                            <div><strong>Created:</strong> ${new Date(org.created_at).toLocaleString()}</div>
                        </div>
                    </div>
                    <div class="bg-slate-50 p-4 rounded-lg">
                        <h3 class="font-bold mb-3">üí≥ Subscription</h3>
                        <div class="space-y-2 text-sm">
                            <div><strong>Status:</strong> ${org.subscription_status}</div>
                            <div><strong>Tier:</strong> ${org.subscription_tier || '-'}</div>
                            <div><strong>Billing:</strong> ${org.billing_interval || '-'}</div>
                            <div><strong>Trial Ends:</strong> ${org.trial_ends_at ? new Date(org.trial_ends_at).toLocaleDateString() : '-'}</div>
                        </div>
                    </div>
                </div>

                <div class="mb-6">
                    <h3 class="font-bold mb-3">üë• Users (${orgUsers.length})</h3>
                    <div class="bg-slate-50 rounded-lg overflow-hidden">
                        <table class="w-full text-sm">
                            <thead class="bg-slate-200">
                                <tr>
                                    <th class="px-3 py-2 text-left">Username</th>
                                    <th class="px-3 py-2 text-left">Role</th>
                                    <th class="px-3 py-2 text-left">Phone</th>
                                    <th class="px-3 py-2 text-left">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-200">
                                ${orgUsers.map(u => `
                                    <tr>
                                        <td class="px-3 py-2">${u.username}</td>
                                        <td class="px-3 py-2">${u.role}</td>
                                        <td class="px-3 py-2">${u.phone || '-'}</td>
                                        <td class="px-3 py-2">
                                            <button onclick="closeOrgModal(); openResetModal('${u.id}')" class="text-purple-600 hover:underline">Reset Password</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="grid md:grid-cols-2 gap-6">
                    <div>
                        <h3 class="font-bold mb-3">üèÜ Teams (${teams?.length || 0})</h3>
                        <div class="bg-slate-50 p-4 rounded-lg max-h-48 overflow-y-auto">
                            ${teams?.length ? teams.map(t => `<div class="py-1">${t.name}</div>`).join('') : '<p class="text-slate-500">No teams</p>'}
                        </div>
                    </div>
                    <div>
                        <h3 class="font-bold mb-3">üìÖ Seasons (${seasons?.length || 0})</h3>
                        <div class="bg-slate-50 p-4 rounded-lg max-h-48 overflow-y-auto">
                            ${seasons?.length ? seasons.map(s => `<div class="py-1">${s.name} ${s.is_active ? '(Active)' : ''}</div>`).join('') : '<p class="text-slate-500">No seasons</p>'}
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('org-modal').classList.remove('hidden');
        }

        function closeOrgModal() {
            document.getElementById('org-modal').classList.add('hidden');
        }

        // ============================================
        // MANUAL SUBSCRIPTION MANAGEMENT
        // ============================================
        async function manualActivate(orgId) {
            const tier = prompt('Enter tier (starter or pro):', 'starter');
            if (!tier || !['starter', 'pro'].includes(tier)) {
                alert('Invalid tier');
                return;
            }

            const { error } = await db.from('organizations')
                .update({
                    subscription_status: 'active',
                    subscription_tier: tier,
                    max_teams: tier === 'pro' ? 50 : 12,
                    max_users: tier === 'pro' ? 500 : 100,
                    max_seasons: tier === 'pro' ? 50 : 10
                })
                .eq('id', orgId);

            if (error) {
                alert('Error: ' + error.message);
            } else {
                alert('Subscription activated!');
                loadOrganizations();
            }
        }

        async function manualCancel(orgId) {
            if (!confirm('Are you sure you want to cancel this subscription?')) return;

            const { error } = await db.from('organizations')
                .update({ subscription_status: 'canceled' })
                .eq('id', orgId);

            if (error) {
                alert('Error: ' + error.message);
            } else {
                alert('Subscription canceled');
                loadOrganizations();
            }
        }

        // ============================================
        // IMPERSONATE USER
        // ============================================
        function impersonateUser(userId) {
            const user = users.find(u => u.id === userId);
            const org = organizations.find(o => o.id === user.org_id);
            
            if (!confirm(`View app as "${user.username}" from "${org?.name}"?\n\nThis will open the app in a new tab with their session.`)) {
                return;
            }
            
            // Create a session for this user
            const sessionData = JSON.stringify({ id: user.id });
            
            // Open app in new tab and set their session
            const newTab = window.open('', '_blank');
            newTab.document.write(`
                <html>
                <head><title>Loading...</title></head>
                <body>
                    <script>
                        localStorage.setItem('plm_session', '${sessionData}');
                        window.location.href = 'https://willismcg.github.io/pool-league-manager/app.html';
                    </script>
                </body>
                </html>
            `);
        }

        function viewAsOrgAdmin(orgId) {
            // Find the admin user for this org
            const org = organizations.find(o => o.id === orgId);
            const adminUser = users.find(u => u.org_id === orgId && u.role === 'admin');
            
            if (!adminUser) {
                alert('No admin user found for this organization');
                return;
            }
            
            impersonateUser(adminUser.id);
        }

        // ============================================
        // INIT
        // ============================================
        document.getElementById('admin-password').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') login();
        });
        
        checkAuth();
    </script>
</body>
</html>
