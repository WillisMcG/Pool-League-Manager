<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pool League Manager - Super Admin</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #1e1b4b 0%, #312e81 50%, #4c1d95 100%);
        }
        .stat-card {
            transition: all 0.3s ease;
        }
        .stat-card:hover {
            transform: translateY(-2px);
        }
    </style>
</head>
<body class="bg-slate-100 min-h-screen">
    <div id="app">
        <!-- Login Screen -->
        <div id="login-screen" class="min-h-screen gradient-bg flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
                <div class="text-center mb-8">
                    <div class="text-5xl mb-4">üõ°Ô∏è</div>
                    <h1 class="text-3xl font-black text-slate-800">Super Admin</h1>
                    <p class="text-slate-600">Pool League Manager</p>
                </div>
                <div class="space-y-4">
                    <input type="password" id="admin-password" placeholder="Admin Password" 
                        class="w-full px-4 py-3 border-2 border-slate-300 rounded-lg focus:border-purple-500 focus:outline-none"
                        onkeypress="if(event.key === 'Enter') login()">
                    <div id="login-error" class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg text-sm"></div>
                    <button onclick="login()" class="w-full py-4 bg-purple-600 text-white font-bold rounded-xl hover:bg-purple-700">
                        Access Dashboard
                    </button>
                </div>
            </div>
        </div>

        <!-- Dashboard -->
        <div id="dashboard" class="hidden">
            <!-- Header -->
            <header class="gradient-bg text-white py-6 px-4 shadow-lg">
                <div class="max-w-7xl mx-auto flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <span class="text-3xl">üõ°Ô∏è</span>
                        <div>
                            <h1 class="text-2xl font-black">Super Admin Dashboard</h1>
                            <p class="text-purple-200 text-sm">Pool League Manager</p>
                        </div>
                    </div>
                    <button onclick="logout()" class="px-4 py-2 bg-white/20 rounded-lg hover:bg-white/30 font-semibold">
                        Logout
                    </button>
                </div>
            </header>

            <!-- Navigation Tabs -->
            <nav class="bg-white shadow-md border-b">
                <div class="max-w-7xl mx-auto px-4 flex gap-1 overflow-x-auto">
                    <button onclick="switchTab('overview')" class="tab-btn px-6 py-4 font-semibold border-b-4 border-transparent hover:text-purple-600" data-tab="overview">
                        üìä Overview
                    </button>
                    <button onclick="switchTab('organizations')" class="tab-btn px-6 py-4 font-semibold border-b-4 border-transparent hover:text-purple-600" data-tab="organizations">
                        üè¢ Organizations
                    </button>
                    <button onclick="switchTab('users')" class="tab-btn px-6 py-4 font-semibold border-b-4 border-transparent hover:text-purple-600" data-tab="users">
                        üë• Users
                    </button>
                    <button onclick="switchTab('logins')" class="tab-btn px-6 py-4 font-semibold border-b-4 border-transparent hover:text-purple-600" data-tab="logins">
                        üìà Login Stats
                    </button>
                </div>
            </nav>

            <!-- Content -->
            <main class="max-w-7xl mx-auto p-4 md:p-6">
                <!-- Overview Tab -->
                <div id="tab-overview" class="tab-content">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                        <div class="stat-card bg-white rounded-xl shadow-lg p-6 border-l-4 border-purple-500">
                            <div class="text-3xl font-black text-purple-600" id="stat-orgs">-</div>
                            <div class="text-slate-600">Organizations</div>
                        </div>
                        <div class="stat-card bg-white rounded-xl shadow-lg p-6 border-l-4 border-blue-500">
                            <div class="text-3xl font-black text-blue-600" id="stat-users">-</div>
                            <div class="text-slate-600">Total Users</div>
                        </div>
                        <div class="stat-card bg-white rounded-xl shadow-lg p-6 border-l-4 border-green-500">
                            <div class="text-3xl font-black text-green-600" id="stat-active">-</div>
                            <div class="text-slate-600">Active Subscriptions</div>
                        </div>
                        <div class="stat-card bg-white rounded-xl shadow-lg p-6 border-l-4 border-amber-500">
                            <div class="text-3xl font-black text-amber-600" id="stat-trials">-</div>
                            <div class="text-slate-600">Trials</div>
                        </div>
                    </div>

                    <!-- Recent Activity -->
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h2 class="text-xl font-bold mb-4">üìà Recent Logins (Last 24 Hours)</h2>
                        <div id="recent-logins" class="space-y-2">Loading...</div>
                    </div>
                </div>

                <!-- Organizations Tab -->
                <div id="tab-organizations" class="tab-content hidden">
                    <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                        <div class="p-4 border-b flex justify-between items-center">
                            <h2 class="text-xl font-bold">üè¢ All Organizations</h2>
                            <input type="text" id="org-search" placeholder="Search..." 
                                class="px-4 py-2 border rounded-lg" onkeyup="filterOrgs()">
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-slate-100">
                                    <tr>
                                        <th class="px-4 py-3 text-left">Name</th>
                                        <th class="px-4 py-3 text-left">Slug</th>
                                        <th class="px-4 py-3 text-center">Status</th>
                                        <th class="px-4 py-3 text-center">Tier</th>
                                        <th class="px-4 py-3 text-center">Users</th>
                                        <th class="px-4 py-3 text-center">Created</th>
                                        <th class="px-4 py-3 text-center">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="orgs-table" class="divide-y">
                                    <tr><td colspan="7" class="px-4 py-8 text-center text-slate-500">Loading...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Users Tab -->
                <div id="tab-users" class="tab-content hidden">
                    <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                        <div class="p-4 border-b flex justify-between items-center flex-wrap gap-2">
                            <h2 class="text-xl font-bold">üë• All Users</h2>
                            <div class="flex gap-2">
                                <select id="user-org-filter" onchange="filterUsers()" class="px-3 py-2 border rounded-lg">
                                    <option value="">All Organizations</option>
                                </select>
                                <input type="text" id="user-search" placeholder="Search name, email, phone..." 
                                    class="px-4 py-2 border rounded-lg" onkeyup="filterUsers()">
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-slate-100">
                                    <tr>
                                        <th class="px-4 py-3 text-left">Name</th>
                                        <th class="px-4 py-3 text-left">Email</th>
                                        <th class="px-4 py-3 text-left">Organization</th>
                                        <th class="px-4 py-3 text-center">Role</th>
                                        <th class="px-4 py-3 text-center">Phone</th>
                                        <th class="px-4 py-3 text-center">Last Login</th>
                                        <th class="px-4 py-3 text-center">Login Count</th>
                                        <th class="px-4 py-3 text-center">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="users-table" class="divide-y">
                                    <tr><td colspan="8" class="px-4 py-8 text-center text-slate-500">Loading...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Login Stats Tab -->
                <div id="tab-logins" class="tab-content hidden">
                    <div class="grid md:grid-cols-3 gap-6 mb-6">
                        <div class="bg-white rounded-xl shadow-lg p-6">
                            <h3 class="text-lg font-bold mb-2">üìä Login Summary</h3>
                            <div class="space-y-3">
                                <div class="flex justify-between">
                                    <span class="text-slate-600">Total Logins (all time)</span>
                                    <span class="font-bold" id="total-logins">-</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-slate-600">Logins Today</span>
                                    <span class="font-bold text-green-600" id="logins-today">-</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-slate-600">Logins This Week</span>
                                    <span class="font-bold text-blue-600" id="logins-week">-</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-slate-600">Users Never Logged In</span>
                                    <span class="font-bold text-amber-600" id="never-logged">-</span>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white rounded-xl shadow-lg p-6">
                            <h3 class="text-lg font-bold mb-2">üèÜ Top Users by Logins</h3>
                            <div id="top-users" class="space-y-2">Loading...</div>
                        </div>
                        <div class="bg-white rounded-xl shadow-lg p-6">
                            <h3 class="text-lg font-bold mb-2">üè¢ Top Orgs by Activity</h3>
                            <div id="top-orgs" class="space-y-2">Loading...</div>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                        <h3 class="text-lg font-bold mb-4">üìÖ Recent Login Activity</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-slate-100">
                                    <tr>
                                        <th class="px-4 py-3 text-left">Name</th>
                                        <th class="px-4 py-3 text-left">Email</th>
                                        <th class="px-4 py-3 text-left">Organization</th>
                                        <th class="px-4 py-3 text-center">Role</th>
                                        <th class="px-4 py-3 text-center">Last Login</th>
                                        <th class="px-4 py-3 text-center">Total Logins</th>
                                    </tr>
                                </thead>
                                <tbody id="login-activity-table" class="divide-y">
                                    <tr><td colspan="6" class="px-4 py-8 text-center text-slate-500">Loading...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h3 class="text-lg font-bold mb-4">‚ö†Ô∏è Users Who Haven't Logged In Recently</h3>
                        <p class="text-sm text-slate-600 mb-4">Users who haven't logged in for more than 30 days</p>
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-slate-100">
                                    <tr>
                                        <th class="px-4 py-3 text-left">Name</th>
                                        <th class="px-4 py-3 text-left">Email</th>
                                        <th class="px-4 py-3 text-left">Organization</th>
                                        <th class="px-4 py-3 text-center">Last Login</th>
                                        <th class="px-4 py-3 text-center">Days Inactive</th>
                                        <th class="px-4 py-3 text-center">Created</th>
                                    </tr>
                                </thead>
                                <tbody id="inactive-users-table" class="divide-y">
                                    <tr><td colspan="6" class="px-4 py-8 text-center text-slate-500">Loading...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </main>
        </div>

        <!-- Password Reset Modal -->
        <div id="reset-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
            <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md mx-4">
                <h2 class="text-2xl font-bold mb-4">üîë Reset Password</h2>
                <div id="reset-user-info" class="bg-slate-50 p-4 rounded-lg mb-4"></div>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-semibold mb-1">New Password</label>
                        <input type="text" id="new-password" placeholder="Enter new password" 
                            class="w-full px-4 py-3 border-2 rounded-lg">
                    </div>
                    <div class="flex gap-3">
                        <button onclick="generatePassword()" class="px-4 py-2 bg-slate-200 rounded-lg font-semibold hover:bg-slate-300">
                            üé≤ Generate
                        </button>
                        <button onclick="confirmResetPassword()" class="flex-1 py-3 bg-purple-600 text-white font-bold rounded-lg hover:bg-purple-700">
                            Reset Password
                        </button>
                    </div>
                    <button onclick="closeResetModal()" class="w-full py-2 text-slate-600 hover:text-slate-800">
                        Cancel
                    </button>
                </div>
            </div>
        </div>

        <!-- Org Details Modal -->
        <div id="org-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 overflow-y-auto">
            <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-4xl mx-4 my-8">
                <div class="flex justify-between items-start mb-6">
                    <h2 class="text-2xl font-bold">üè¢ Organization Details</h2>
                    <div class="flex items-center gap-2">
                        <button onclick="deleteFromOrgModal()" class="px-4 py-2 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 font-medium text-sm">
                            üóëÔ∏è Delete Org
                        </button>
                        <button onclick="closeOrgModal()" class="text-slate-400 hover:text-slate-600 text-2xl">&times;</button>
                    </div>
                </div>
                <div id="org-details-content">Loading...</div>
            </div>
        </div>

        <!-- Delete Organization Confirmation Modal -->
        <div id="delete-org-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
            <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-lg mx-4">
                <div class="text-center mb-6">
                    <div class="text-5xl mb-4">‚ö†Ô∏è</div>
                    <h2 class="text-2xl font-bold text-red-600">Delete Organization</h2>
                    <p class="text-slate-600 mt-2">This action cannot be undone!</p>
                </div>
                <div id="delete-org-info" class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6"></div>
                <div class="bg-slate-50 rounded-lg p-4 mb-6">
                    <p class="font-semibold text-slate-700 mb-2">The following will be permanently deleted:</p>
                    <ul id="delete-summary" class="text-sm text-slate-600 space-y-1"></ul>
                </div>
                <div class="space-y-3">
                    <div>
                        <label class="block text-sm font-semibold mb-1 text-red-700">Type the organization name to confirm:</label>
                        <input type="text" id="delete-confirm-name" placeholder="Organization name" 
                            class="w-full px-4 py-3 border-2 border-red-300 rounded-lg focus:border-red-500 focus:outline-none">
                    </div>
                    <button onclick="executeDeleteOrg()" id="delete-org-btn" disabled
                        class="w-full py-3 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700 disabled:bg-slate-300 disabled:cursor-not-allowed">
                        üóëÔ∏è Permanently Delete Organization
                    </button>
                    <button onclick="closeDeleteOrgModal()" class="w-full py-2 text-slate-600 hover:text-slate-800">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // CONFIGURATION
        // ============================================
        const SUPABASE_URL = 'https://hprdhlletatixqysqegi.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhwcmRobGxldGF0aXhxeXNxZWdpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgwOTU1NDMsImV4cCI6MjA4MzY3MTU0M30._wrv6ONjG3JRkpA1FDPFkKMSn0bi6vhMiR0UZB40IRk';
        
        // CHANGE THIS to your own secure password!
        const SUPER_ADMIN_PASSWORD = 'PoolLeagueAdmin2025!';

        // ============================================
        // INITIALIZE SUPABASE
        // ============================================
        const { createClient } = supabase;
        const db = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // ============================================
        // STATE
        // ============================================
        let allOrgs = [];
        let allUsers = [];
        let currentTab = 'overview';
        let resetUserId = null;

        // ============================================
        // AUTH
        // ============================================
        function login() {
            const password = document.getElementById('admin-password').value;
            if (password === SUPER_ADMIN_PASSWORD) {
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('dashboard').classList.remove('hidden');
                localStorage.setItem('plm_admin_session', 'true');
                loadDashboard();
            } else {
                document.getElementById('login-error').textContent = 'Invalid password';
                document.getElementById('login-error').classList.remove('hidden');
            }
        }

        function logout() {
            localStorage.removeItem('plm_admin_session');
            document.getElementById('dashboard').classList.add('hidden');
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('admin-password').value = '';
        }

        function checkSession() {
            if (localStorage.getItem('plm_admin_session') === 'true') {
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('dashboard').classList.remove('hidden');
                loadDashboard();
            }
        }

        // ============================================
        // TABS
        // ============================================
        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(`tab-${tab}`).classList.remove('hidden');
            
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('text-purple-600', 'border-purple-600');
                btn.classList.add('border-transparent');
            });
            document.querySelector(`[data-tab="${tab}"]`).classList.add('text-purple-600', 'border-purple-600');
        }

        // ============================================
        // LOAD DATA
        // ============================================
        async function loadDashboard() {
            switchTab('overview');
            await Promise.all([
                loadOrganizations(),
                loadUsers()
            ]);
            updateStats();
            updateRecentLogins();
            updateLoginStats();
        }

        async function loadOrganizations() {
            const { data, error } = await db.from('organizations').select('*').order('created_at', { ascending: false });
            if (error) {
                console.error('Error loading orgs:', error);
                return;
            }
            allOrgs = data || [];
            renderOrgsTable();
            updateOrgFilter();
        }

        async function loadUsers() {
            const { data, error } = await db.from('users').select('*').order('last_login', { ascending: false, nullsFirst: false });
            if (error) {
                console.error('Error loading users:', error);
                return;
            }
            allUsers = data || [];
            renderUsersTable();
        }

        // ============================================
        // STATS
        // ============================================
        function updateStats() {
            document.getElementById('stat-orgs').textContent = allOrgs.length;
            document.getElementById('stat-users').textContent = allUsers.length;
            document.getElementById('stat-active').textContent = allOrgs.filter(o => o.subscription_status === 'active').length;
            document.getElementById('stat-trials').textContent = allOrgs.filter(o => o.subscription_status === 'trial').length;
        }

        function updateRecentLogins() {
            const yesterday = new Date(Date.now() - 24 * 60 * 60 * 1000);
            const recentLogins = allUsers
                .filter(u => u.last_login && new Date(u.last_login) > yesterday)
                .sort((a, b) => new Date(b.last_login) - new Date(a.last_login))
                .slice(0, 10);

            const container = document.getElementById('recent-logins');
            if (recentLogins.length === 0) {
                container.innerHTML = '<p class="text-slate-500">No logins in the last 24 hours</p>';
                return;
            }

            container.innerHTML = recentLogins.map(u => {
                const org = allOrgs.find(o => o.id === u.org_id);
                const timeAgo = formatTimeAgo(u.last_login);
                const fullName = [u.first_name, u.last_name].filter(Boolean).join(' ');
                return `
                    <div class="flex items-center justify-between p-2 bg-slate-50 rounded-lg">
                        <div>
                            <span class="font-semibold">${fullName || u.email}</span>
                            ${fullName ? `<span class="text-slate-500 text-sm ml-1">(${u.email})</span>` : ''}
                            <span class="text-slate-500 text-sm ml-2">${org?.name || 'Unknown'}</span>
                        </div>
                        <span class="text-sm text-slate-500">${timeAgo}</span>
                    </div>
                `;
            }).join('');
        }

        function updateLoginStats() {
            // Total logins
            const totalLogins = allUsers.reduce((sum, u) => sum + (u.login_count || 0), 0);
            document.getElementById('total-logins').textContent = totalLogins.toLocaleString();

            // Logins today
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const loginsToday = allUsers.filter(u => u.last_login && new Date(u.last_login) >= today).length;
            document.getElementById('logins-today').textContent = loginsToday;

            // Logins this week
            const weekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
            const loginsWeek = allUsers.filter(u => u.last_login && new Date(u.last_login) >= weekAgo).length;
            document.getElementById('logins-week').textContent = loginsWeek;

            // Never logged in
            const neverLogged = allUsers.filter(u => !u.last_login && !u.login_count).length;
            document.getElementById('never-logged').textContent = neverLogged;

            // Top users by logins
            const topUsers = [...allUsers]
                .filter(u => u.login_count > 0)
                .sort((a, b) => (b.login_count || 0) - (a.login_count || 0))
                .slice(0, 5);
            
            document.getElementById('top-users').innerHTML = topUsers.length === 0 
                ? '<p class="text-slate-500 text-sm">No login data yet</p>'
                : topUsers.map((u, i) => {
                    const org = allOrgs.find(o => o.id === u.org_id);
                    const fullName = [u.first_name, u.last_name].filter(Boolean).join(' ');
                    const displayName = fullName || u.email;
                    return `
                        <div class="flex items-center justify-between p-2 ${i === 0 ? 'bg-yellow-50' : 'bg-slate-50'} rounded">
                            <div class="min-w-0 flex-1">
                                <span class="${i === 0 ? 'font-bold' : 'font-medium'} truncate block">${i + 1}. ${displayName}</span>
                                <span class="text-slate-500 text-xs">${org?.name || ''}</span>
                            </div>
                            <span class="font-bold text-purple-600 ml-2">${u.login_count || 0}</span>
                        </div>
                    `;
                }).join('');

            // Top orgs by activity
            const orgActivity = {};
            allUsers.forEach(u => {
                if (u.org_id) {
                    orgActivity[u.org_id] = (orgActivity[u.org_id] || 0) + (u.login_count || 0);
                }
            });
            
            const topOrgsActivity = Object.entries(orgActivity)
                .map(([orgId, count]) => ({ org: allOrgs.find(o => o.id === orgId), count }))
                .filter(o => o.org)
                .sort((a, b) => b.count - a.count)
                .slice(0, 5);

            document.getElementById('top-orgs').innerHTML = topOrgsActivity.length === 0
                ? '<p class="text-slate-500 text-sm">No activity data yet</p>'
                : topOrgsActivity.map((o, i) => `
                    <div class="flex items-center justify-between p-2 ${i === 0 ? 'bg-green-50' : 'bg-slate-50'} rounded">
                        <span class="${i === 0 ? 'font-bold' : 'font-medium'}">${i + 1}. ${o.org.name}</span>
                        <span class="font-bold text-green-600">${o.count} logins</span>
                    </div>
                `).join('');

            // Recent login activity table
            const recentActivity = [...allUsers]
                .filter(u => u.last_login)
                .sort((a, b) => new Date(b.last_login) - new Date(a.last_login))
                .slice(0, 20);

            document.getElementById('login-activity-table').innerHTML = recentActivity.length === 0
                ? '<tr><td colspan="6" class="px-4 py-8 text-center text-slate-500">No login data available</td></tr>'
                : recentActivity.map(u => {
                    const org = allOrgs.find(o => o.id === u.org_id);
                    const fullName = [u.first_name, u.last_name].filter(Boolean).join(' ') || '-';
                    return `
                        <tr class="hover:bg-slate-50">
                            <td class="px-4 py-3 font-medium">${fullName}</td>
                            <td class="px-4 py-3 text-slate-600">${u.email}</td>
                            <td class="px-4 py-3 text-slate-600">${org?.name || '-'}</td>
                            <td class="px-4 py-3 text-center">
                                <span class="px-2 py-1 rounded text-xs font-medium ${u.role === 'admin' ? 'bg-purple-100 text-purple-800' : 'bg-slate-100 text-slate-600'}">
                                    ${u.role || 'user'}
                                </span>
                            </td>
                            <td class="px-4 py-3 text-center text-sm">${formatDateTime(u.last_login)}</td>
                            <td class="px-4 py-3 text-center font-semibold">${u.login_count || 0}</td>
                        </tr>
                    `;
                }).join('');

            // Inactive users table (no login in 30+ days)
            const thirtyDaysAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);
            const inactiveUsers = allUsers
                .filter(u => {
                    if (!u.last_login) return true; // Never logged in
                    return new Date(u.last_login) < thirtyDaysAgo;
                })
                .sort((a, b) => {
                    if (!a.last_login && !b.last_login) return 0;
                    if (!a.last_login) return 1;
                    if (!b.last_login) return -1;
                    return new Date(a.last_login) - new Date(b.last_login);
                })
                .slice(0, 20);

            document.getElementById('inactive-users-table').innerHTML = inactiveUsers.length === 0
                ? '<tr><td colspan="6" class="px-4 py-8 text-center text-green-600">üéâ All users are active!</td></tr>'
                : inactiveUsers.map(u => {
                    const org = allOrgs.find(o => o.id === u.org_id);
                    const fullName = [u.first_name, u.last_name].filter(Boolean).join(' ') || '-';
                    const daysInactive = u.last_login 
                        ? Math.floor((Date.now() - new Date(u.last_login)) / (24 * 60 * 60 * 1000))
                        : 'Never';
                    return `
                        <tr class="hover:bg-slate-50">
                            <td class="px-4 py-3 font-medium">${fullName}</td>
                            <td class="px-4 py-3 text-slate-600">${u.email}</td>
                            <td class="px-4 py-3 text-slate-600">${org?.name || '-'}</td>
                            <td class="px-4 py-3 text-center text-sm">${u.last_login ? formatDateTime(u.last_login) : '<span class="text-amber-600">Never</span>'}</td>
                            <td class="px-4 py-3 text-center">
                                <span class="px-2 py-1 rounded text-xs font-bold ${daysInactive === 'Never' ? 'bg-amber-100 text-amber-800' : daysInactive > 60 ? 'bg-red-100 text-red-800' : 'bg-yellow-100 text-yellow-800'}">
                                    ${daysInactive === 'Never' ? 'Never' : daysInactive + ' days'}
                                </span>
                            </td>
                            <td class="px-4 py-3 text-center text-sm text-slate-500">${formatDate(u.created_at)}</td>
                        </tr>
                    `;
                }).join('');
        }

        // ============================================
        // RENDER TABLES
        // ============================================
        function renderOrgsTable() {
            const search = (document.getElementById('org-search')?.value || '').toLowerCase();
            const filtered = allOrgs.filter(o => 
                o.name.toLowerCase().includes(search) || 
                o.slug?.toLowerCase().includes(search)
            );

            document.getElementById('orgs-table').innerHTML = filtered.length === 0
                ? '<tr><td colspan="7" class="px-4 py-8 text-center text-slate-500">No organizations found</td></tr>'
                : filtered.map(org => {
                    const userCount = allUsers.filter(u => u.org_id === org.id).length;
                    const statusColors = {
                        active: 'bg-green-100 text-green-800',
                        trial: 'bg-yellow-100 text-yellow-800',
                        expired: 'bg-red-100 text-red-800',
                        canceled: 'bg-slate-100 text-slate-800'
                    };
                    return `
                        <tr class="hover:bg-slate-50">
                            <td class="px-4 py-3 font-semibold">${org.name}</td>
                            <td class="px-4 py-3 text-slate-600">${org.slug || '-'}</td>
                            <td class="px-4 py-3 text-center">
                                <span class="px-2 py-1 rounded text-xs font-medium ${statusColors[org.subscription_status] || 'bg-slate-100'}">
                                    ${org.subscription_status || 'none'}
                                </span>
                            </td>
                            <td class="px-4 py-3 text-center text-sm">${org.subscription_tier || '-'}</td>
                            <td class="px-4 py-3 text-center font-semibold">${userCount}</td>
                            <td class="px-4 py-3 text-center text-sm text-slate-500">${formatDate(org.created_at)}</td>
                            <td class="px-4 py-3 text-center space-x-2">
                                <button onclick="viewOrgDetails('${org.id}')" class="text-purple-600 hover:text-purple-800 font-medium text-sm">
                                    View
                                </button>
                                <button onclick="confirmDeleteOrg('${org.id}', '${org.name.replace(/'/g, "\\'")}', '${org.slug || ''}', '${org.subscription_status || ''}')" class="text-red-600 hover:text-red-800 font-medium text-sm">
                                    Delete
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');
        }

        function renderUsersTable() {
            const search = (document.getElementById('user-search')?.value || '').toLowerCase();
            const orgFilter = document.getElementById('user-org-filter')?.value || '';
            
            const filtered = allUsers.filter(u => {
                const fullName = `${u.first_name || ''} ${u.last_name || ''}`.toLowerCase();
                const matchesSearch = u.email?.toLowerCase().includes(search) || 
                    u.phone?.toLowerCase().includes(search) ||
                    fullName.includes(search);
                const matchesOrg = !orgFilter || u.org_id === orgFilter;
                return matchesSearch && matchesOrg;
            });

            document.getElementById('users-table').innerHTML = filtered.length === 0
                ? '<tr><td colspan="8" class="px-4 py-8 text-center text-slate-500">No users found</td></tr>'
                : filtered.map(user => {
                    const org = allOrgs.find(o => o.id === user.org_id);
                    const fullName = [user.first_name, user.last_name].filter(Boolean).join(' ') || '-';
                    return `
                        <tr class="hover:bg-slate-50">
                            <td class="px-4 py-3 font-semibold">${fullName}</td>
                            <td class="px-4 py-3 text-slate-600">${user.email || '-'}</td>
                            <td class="px-4 py-3 text-slate-600">${org?.name || '-'}</td>
                            <td class="px-4 py-3 text-center">
                                <span class="px-2 py-1 rounded text-xs font-medium ${user.role === 'admin' ? 'bg-purple-100 text-purple-800' : 'bg-slate-100'}">
                                    ${user.role || 'user'}
                                </span>
                            </td>
                            <td class="px-4 py-3 text-center text-sm">${user.phone || '-'}</td>
                            <td class="px-4 py-3 text-center text-sm">
                                ${user.last_login ? formatDateTime(user.last_login) : '<span class="text-slate-400">Never</span>'}
                            </td>
                            <td class="px-4 py-3 text-center font-semibold">${user.login_count || 0}</td>
                            <td class="px-4 py-3 text-center">
                                <button onclick="openResetModal('${user.id}')" class="text-purple-600 hover:text-purple-800 font-medium text-sm">
                                    Reset Password
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');
        }

        function updateOrgFilter() {
            const select = document.getElementById('user-org-filter');
            select.innerHTML = '<option value="">All Organizations</option>' + 
                allOrgs.map(o => `<option value="${o.id}">${o.name}</option>`).join('');
        }

        function filterOrgs() {
            renderOrgsTable();
        }

        function filterUsers() {
            renderUsersTable();
        }

        // ============================================
        // PASSWORD RESET
        // ============================================
        function openResetModal(userId) {
            resetUserId = userId;
            const user = allUsers.find(u => u.id === userId);
            const org = allOrgs.find(o => o.id === user?.org_id);
            const fullName = [user?.first_name, user?.last_name].filter(Boolean).join(' ');
            
            document.getElementById('reset-user-info').innerHTML = `
                <div class="font-semibold">${fullName || 'No name'}</div>
                <div class="text-sm text-slate-600">${user?.email || 'Unknown'}</div>
                <div class="text-sm text-slate-600">${org?.name || 'No organization'}</div>
                <div class="text-sm text-slate-600">Phone: ${user?.phone || 'N/A'}</div>
            `;
            document.getElementById('new-password').value = '';
            document.getElementById('reset-modal').classList.remove('hidden');
        }

        function closeResetModal() {
            document.getElementById('reset-modal').classList.add('hidden');
            resetUserId = null;
        }

        function generatePassword() {
            const chars = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let password = '';
            for (let i = 0; i < 8; i++) {
                password += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            document.getElementById('new-password').value = password;
        }

        async function confirmResetPassword() {
            if (!resetUserId) return;
            
            const newPassword = document.getElementById('new-password').value;
            if (!newPassword || newPassword.length < 4) {
                alert('Password must be at least 4 characters');
                return;
            }

            const { error } = await db.from('users')
                .update({ password: newPassword })
                .eq('id', resetUserId);

            if (error) {
                alert('Error resetting password: ' + error.message);
                return;
            }

            const user = allUsers.find(u => u.id === resetUserId);
            const fullName = [user?.first_name, user?.last_name].filter(Boolean).join(' ') || 'Unknown';
            alert(`Password reset successfully!\n\nName: ${fullName}\nEmail: ${user?.email}\nNew Password: ${newPassword}`);
            closeResetModal();
        }

        // ============================================
        // ORG DETAILS
        // ============================================
        let currentViewOrgId = null;
        
        async function viewOrgDetails(orgId) {
            currentViewOrgId = orgId;
            const org = allOrgs.find(o => o.id === orgId);
            const orgUsers = allUsers.filter(u => u.org_id === orgId);
            
            // Load teams and seasons
            const [teamsRes, seasonsRes] = await Promise.all([
                db.from('teams').select('*').eq('org_id', orgId),
                db.from('seasons').select('*').eq('org_id', orgId)
            ]);

            const teams = teamsRes.data || [];
            const seasons = seasonsRes.data || [];

            document.getElementById('org-details-content').innerHTML = `
                <div class="grid md:grid-cols-2 gap-6">
                    <div>
                        <h3 class="font-bold text-lg mb-3">üìã Organization Info</h3>
                        <div class="bg-slate-50 rounded-lg p-4 space-y-2">
                            <div><span class="text-slate-600">Name:</span> <strong>${org.name}</strong></div>
                            <div><span class="text-slate-600">Slug:</span> ${org.slug || '-'}</div>
                            <div><span class="text-slate-600">Status:</span> <span class="px-2 py-1 rounded text-xs ${org.subscription_status === 'active' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">${org.subscription_status}</span></div>
                            <div><span class="text-slate-600">Tier:</span> ${org.subscription_tier || '-'}</div>
                            <div><span class="text-slate-600">Billing:</span> ${org.billing_interval || '-'}</div>
                            <div><span class="text-slate-600">Created:</span> ${formatDateTime(org.created_at)}</div>
                            ${org.trial_ends_at ? `<div><span class="text-slate-600">Trial Ends:</span> ${formatDate(org.trial_ends_at)}</div>` : ''}
                        </div>
                    </div>
                    <div>
                        <h3 class="font-bold text-lg mb-3">üìä Statistics</h3>
                        <div class="grid grid-cols-2 gap-3">
                            <div class="bg-blue-50 rounded-lg p-3 text-center">
                                <div class="text-2xl font-black text-blue-600">${orgUsers.length}</div>
                                <div class="text-sm text-blue-700">Users</div>
                            </div>
                            <div class="bg-green-50 rounded-lg p-3 text-center">
                                <div class="text-2xl font-black text-green-600">${teams.length}</div>
                                <div class="text-sm text-green-700">Teams</div>
                            </div>
                            <div class="bg-purple-50 rounded-lg p-3 text-center">
                                <div class="text-2xl font-black text-purple-600">${seasons.length}</div>
                                <div class="text-sm text-purple-700">Seasons</div>
                            </div>
                            <div class="bg-amber-50 rounded-lg p-3 text-center">
                                <div class="text-2xl font-black text-amber-600">${orgUsers.reduce((sum, u) => sum + (u.login_count || 0), 0)}</div>
                                <div class="text-sm text-amber-700">Total Logins</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-6">
                    <h3 class="font-bold text-lg mb-3">üë• Users (${orgUsers.length})</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead class="bg-slate-100">
                                <tr>
                                    <th class="px-3 py-2 text-left">Name</th>
                                    <th class="px-3 py-2 text-left">Email</th>
                                    <th class="px-3 py-2 text-center">Role</th>
                                    <th class="px-3 py-2 text-center">Phone</th>
                                    <th class="px-3 py-2 text-center">Last Login</th>
                                    <th class="px-3 py-2 text-center">Logins</th>
                                    <th class="px-3 py-2 text-center">Action</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y">
                                ${orgUsers.map(u => {
                                    const fullName = [u.first_name, u.last_name].filter(Boolean).join(' ') || '-';
                                    return \`
                                    <tr class="hover:bg-slate-50">
                                        <td class="px-3 py-2 font-medium">\${fullName}</td>
                                        <td class="px-3 py-2 text-slate-600">\${u.email}</td>
                                        <td class="px-3 py-2 text-center">
                                            <span class="px-2 py-0.5 rounded text-xs \${u.role === 'admin' ? 'bg-purple-100 text-purple-800' : 'bg-slate-100'}">\${u.role}</span>
                                        </td>
                                        <td class="px-3 py-2 text-center">\${u.phone || '-'}</td>
                                        <td class="px-3 py-2 text-center">\${u.last_login ? formatDateTime(u.last_login) : '<span class="text-slate-400">Never</span>'}</td>
                                        <td class="px-3 py-2 text-center font-semibold">\${u.login_count || 0}</td>
                                        <td class="px-3 py-2 text-center">
                                            <button onclick="closeOrgModal(); openResetModal('\${u.id}')" class="text-purple-600 hover:underline">Reset PW</button>
                                        </td>
                                    </tr>
                                \`}).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;

            document.getElementById('org-modal').classList.remove('hidden');
        }

        function closeOrgModal() {
            document.getElementById('org-modal').classList.add('hidden');
            currentViewOrgId = null;
        }

        function deleteFromOrgModal() {
            if (!currentViewOrgId) return;
            const org = allOrgs.find(o => o.id === currentViewOrgId);
            closeOrgModal();
            if (org) {
                confirmDeleteOrg(org.id, org.name, org.slug, org.subscription_status);
            }
        }

        // ============================================
        // DELETE ORGANIZATION
        // ============================================
        let deleteOrgId = null;
        let deleteOrgName = null;
        let deleteOrgData = null;

        async function confirmDeleteOrg(orgId, orgName, orgSlug, orgStatus) {
            deleteOrgId = orgId;
            deleteOrgName = orgName || '';
            
            console.log('Delete org:', { orgId, orgName, orgSlug, orgStatus });
            
            // Show loading state
            document.getElementById('delete-org-info').innerHTML = `<div class="text-center">Loading organization data...</div>`;
            document.getElementById('delete-summary').innerHTML = '<li>Calculating...</li>';
            document.getElementById('delete-org-modal').classList.remove('hidden');
            document.getElementById('delete-confirm-name').value = '';
            document.getElementById('delete-org-btn').disabled = true;
            
            // Gather all related data counts
            deleteOrgData = await gatherOrgData(orgId);
            
            // Display org info
            document.getElementById('delete-org-info').innerHTML = `
                <div class="font-bold text-lg text-red-800">${orgName || 'Unknown'}</div>
                <div class="text-sm text-red-700">Slug: ${orgSlug || '-'}</div>
                <div class="text-sm text-red-700">Status: ${orgStatus || '-'}</div>
            `;
            
            // Display deletion summary
            const summaryItems = [];
            summaryItems.push(`<li>‚Ä¢ <strong>${deleteOrgData.users}</strong> user(s)</li>`);
            summaryItems.push(`<li>‚Ä¢ <strong>${deleteOrgData.teams}</strong> team(s)</li>`);
            summaryItems.push(`<li>‚Ä¢ <strong>${deleteOrgData.players}</strong> player(s)</li>`);
            summaryItems.push(`<li>‚Ä¢ <strong>${deleteOrgData.seasons}</strong> season(s)</li>`);
            summaryItems.push(`<li>‚Ä¢ <strong>${deleteOrgData.schedules}</strong> scheduled match(es)</li>`);
            summaryItems.push(`<li>‚Ä¢ <strong>${deleteOrgData.matches}</strong> completed match(es)</li>`);
            summaryItems.push(`<li>‚Ä¢ <strong>${deleteOrgData.submissions}</strong> score submission(s)</li>`);
            summaryItems.push(`<li>‚Ä¢ <strong>${deleteOrgData.venues}</strong> venue(s)</li>`);
            summaryItems.push(`<li class="pt-2 font-semibold text-red-700">‚Ä¢ 1 organization record</li>`);
            
            document.getElementById('delete-summary').innerHTML = summaryItems.join('');
            
            // Enable delete button when name matches
            document.getElementById('delete-confirm-name').oninput = function() {
                const inputVal = this.value.trim().toLowerCase();
                const targetVal = deleteOrgName.toLowerCase();
                const matches = inputVal === targetVal;
                console.log('Comparing:', { input: inputVal, target: targetVal, matches });
                document.getElementById('delete-org-btn').disabled = !matches;
            };
        }

        async function gatherOrgData(orgId) {
            const data = {
                users: 0,
                teams: 0,
                players: 0,
                seasons: 0,
                schedules: 0,
                matches: 0,
                submissions: 0,
                venues: 0,
                teamIds: [],
                seasonIds: [],
                scheduleIds: []
            };
            
            try {
                // Get users count
                const { data: users } = await db.from('users').select('id').eq('org_id', orgId);
                data.users = users?.length || 0;
                
                // Get teams
                const { data: teams } = await db.from('teams').select('id').eq('org_id', orgId);
                data.teams = teams?.length || 0;
                data.teamIds = teams?.map(t => t.id) || [];
                
                // Get players (via teams)
                if (data.teamIds.length > 0) {
                    const { data: players } = await db.from('players').select('id').in('team_id', data.teamIds);
                    data.players = players?.length || 0;
                }
                
                // Get seasons
                const { data: seasons } = await db.from('seasons').select('id').eq('org_id', orgId);
                data.seasons = seasons?.length || 0;
                data.seasonIds = seasons?.map(s => s.id) || [];
                
                // Get schedules (via seasons)
                if (data.seasonIds.length > 0) {
                    const { data: schedules } = await db.from('schedule').select('id').in('season_id', data.seasonIds);
                    data.schedules = schedules?.length || 0;
                    data.scheduleIds = schedules?.map(s => s.id) || [];
                }
                
                // Get matches (via schedules)
                if (data.scheduleIds.length > 0) {
                    const { data: matches } = await db.from('matches').select('id').in('schedule_id', data.scheduleIds);
                    data.matches = matches?.length || 0;
                }
                
                // Get submissions (via schedules)
                if (data.scheduleIds.length > 0) {
                    const { data: submissions } = await db.from('submissions').select('id').in('schedule_id', data.scheduleIds);
                    data.submissions = submissions?.length || 0;
                }
                
                // Get venues
                const { data: venues } = await db.from('venues').select('id').eq('org_id', orgId);
                data.venues = venues?.length || 0;
                
            } catch (err) {
                console.error('Error gathering org data:', err);
            }
            
            return data;
        }

        async function executeDeleteOrg() {
            if (!deleteOrgId || !deleteOrgData) return;
            
            const confirmName = document.getElementById('delete-confirm-name').value.trim();
            if (confirmName.toLowerCase() !== deleteOrgName.toLowerCase()) {
                alert('Organization name does not match');
                return;
            }
            
            // Disable button and show progress
            const btn = document.getElementById('delete-org-btn');
            btn.disabled = true;
            btn.innerHTML = 'üîÑ Deleting... Please wait';
            
            try {
                console.log('Starting deletion for org:', deleteOrgId);
                
                // Delete in order: deepest children first, then work up to parent
                
                // 1. Delete match_games (if table exists) - via matches via schedules
                if (deleteOrgData.scheduleIds.length > 0) {
                    // First get match IDs
                    const { data: matchesToDelete } = await db.from('matches').select('id').in('schedule_id', deleteOrgData.scheduleIds);
                    const matchIds = matchesToDelete?.map(m => m.id) || [];
                    
                    if (matchIds.length > 0) {
                        console.log('Deleting match_games for', matchIds.length, 'matches');
                        await db.from('match_games').delete().in('match_id', matchIds);
                    }
                }
                
                // 2. Delete submissions (via schedules)
                if (deleteOrgData.scheduleIds.length > 0) {
                    console.log('Deleting submissions');
                    await db.from('submissions').delete().in('schedule_id', deleteOrgData.scheduleIds);
                }
                
                // 3. Delete matches (via schedules)
                if (deleteOrgData.scheduleIds.length > 0) {
                    console.log('Deleting matches');
                    await db.from('matches').delete().in('schedule_id', deleteOrgData.scheduleIds);
                }
                
                // 4. Delete schedules (via seasons)
                if (deleteOrgData.seasonIds.length > 0) {
                    console.log('Deleting schedules');
                    await db.from('schedule').delete().in('season_id', deleteOrgData.seasonIds);
                }
                
                // 5. Delete players (via teams)
                if (deleteOrgData.teamIds.length > 0) {
                    console.log('Deleting players');
                    await db.from('players').delete().in('team_id', deleteOrgData.teamIds);
                }
                
                // 6. Delete teams
                console.log('Deleting teams');
                await db.from('teams').delete().eq('org_id', deleteOrgId);
                
                // 7. Delete seasons
                console.log('Deleting seasons');
                await db.from('seasons').delete().eq('org_id', deleteOrgId);
                
                // 8. Delete venues
                console.log('Deleting venues');
                await db.from('venues').delete().eq('org_id', deleteOrgId);
                
                // 9. Delete users
                console.log('Deleting users');
                await db.from('users').delete().eq('org_id', deleteOrgId);
                
                // 10. Finally delete the organization
                console.log('Deleting organization');
                const { error: orgError } = await db.from('organizations').delete().eq('id', deleteOrgId);
                
                if (orgError) {
                    throw orgError;
                }
                
                console.log('Deletion complete!');
                alert(`Organization "${deleteOrgName}" and all related data have been permanently deleted.`);
                
                closeDeleteOrgModal();
                
                // Refresh the data
                await loadDashboard();
                
            } catch (err) {
                console.error('Error deleting organization:', err);
                alert('Error deleting organization: ' + (err.message || 'Unknown error') + '\n\nCheck console for details.');
                btn.disabled = false;
                btn.innerHTML = 'üóëÔ∏è Permanently Delete Organization';
            }
        }

        function closeDeleteOrgModal() {
            document.getElementById('delete-org-modal').classList.add('hidden');
            deleteOrgId = null;
            deleteOrgName = null;
            deleteOrgData = null;
        }

        // ============================================
        // UTILITIES
        // ============================================
        function formatDate(dateStr) {
            if (!dateStr) return '-';
            return new Date(dateStr).toLocaleDateString();
        }

        function formatDateTime(dateStr) {
            if (!dateStr) return '-';
            const d = new Date(dateStr);
            return d.toLocaleDateString() + ' ' + d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        function formatTimeAgo(dateStr) {
            if (!dateStr) return '';
            const diff = Date.now() - new Date(dateStr);
            const mins = Math.floor(diff / 60000);
            if (mins < 1) return 'Just now';
            if (mins < 60) return `${mins}m ago`;
            const hours = Math.floor(mins / 60);
            if (hours < 24) return `${hours}h ago`;
            const days = Math.floor(hours / 24);
            return `${days}d ago`;
        }

        // ============================================
        // INIT
        // ============================================
        checkSession();
    </script>
</body>
</html>
