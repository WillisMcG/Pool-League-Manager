<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pool League Manager - Full Version</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * { box-sizing: border-box; }
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
        .tab-scroll::-webkit-scrollbar { height: 4px; }
        .tab-scroll::-webkit-scrollbar-thumb { background: #10b981; border-radius: 2px; }
    </style>
</head>
<body>
    <div id="app"></div>

    <script>
        console.log('Pool League Manager Loading...');

        // Storage helper
        const storage = {
            get: (key) => {
                const val = localStorage.getItem('plm_' + key);
                return val ? JSON.parse(val) : null;
            },
            set: (key, value) => {
                localStorage.setItem('plm_' + key, JSON.stringify(value));
            }
        };

        // State
        let state = {
            users: storage.get('users') || [],
            teams: storage.get('teams') || [],
            schedule: storage.get('schedule') || [],
            submissions: storage.get('submissions') || [],
            matches: storage.get('matches') || [],
            currentUser: null,
            activeTab: 'schedule',
            leagueName: storage.get('leagueName') || 'Pool League',
            showCreateTeam: false,
            showGenSchedule: false,
            showManualEntry: false,
            playDays: storage.get('playDays') || [2], // Default Tuesday (0=Sun, 1=Mon, 2=Tue, etc.)
            manualEntry: {
                week: '',
                date: '',
                homeTeamId: '',
                awayTeamId: '',
                half: 1,
                isPositionNight: false
            },
            selectedMatch: '',
            selectedTeam: '',
            matchups: Array(5).fill(null).map(() => ({ homePlayer: '', awayPlayer: '', homeGames: '', awayGames: '' }))
        };

        // Save functions
        function saveState(key, value) {
            state[key] = value;
            storage.set(key, value);
            render();
        }

        function saveUsers(users) { saveState('users', users); }
        function saveTeams(teams) { saveState('teams', teams); }
        function saveSchedule(schedule) { saveState('schedule', schedule); }
        function saveSubmissions(submissions) { saveState('submissions', submissions); }
        function saveMatches(matches) { saveState('matches', matches); }
        function saveLeagueName(name) { saveState('leagueName', name); }
        function savePlayDays(days) { saveState('playDays', days); }

        // Manual schedule entry helpers
        function getNextWeekNumber() {
            if (state.schedule.length === 0) return '1';
            const maxWeek = Math.max(...state.schedule.map(s => parseInt(s.week) || 0));
            return (maxWeek + 1).toString();
        }

        function getLastScheduleDate() {
            if (state.schedule.length === 0) return null;
            const sorted = [...state.schedule].sort((a, b) => new Date(b.date) - new Date(a.date));
            return sorted[0]?.date || null;
        }

        function getNextPlayDate(fromDate = null) {
            const playDays = state.playDays;
            if (playDays.length === 0) return '';
            
            let startDate;
            if (fromDate) {
                startDate = new Date(fromDate);
                startDate.setDate(startDate.getDate() + 1); // Start from day after
            } else {
                const lastDate = getLastScheduleDate();
                if (lastDate) {
                    startDate = new Date(lastDate);
                    startDate.setDate(startDate.getDate() + 1);
                } else {
                    startDate = new Date();
                }
            }
            
            // Find the next play day
            for (let i = 0; i < 14; i++) { // Look up to 2 weeks ahead
                const checkDate = new Date(startDate);
                checkDate.setDate(checkDate.getDate() + i);
                if (playDays.includes(checkDate.getDay())) {
                    return checkDate.toISOString().split('T')[0];
                }
            }
            
            return startDate.toISOString().split('T')[0];
        }

        function togglePlayDay(day) {
            const days = [...state.playDays];
            const idx = days.indexOf(day);
            if (idx >= 0) {
                days.splice(idx, 1);
            } else {
                days.push(day);
                days.sort((a, b) => a - b);
            }
            savePlayDays(days);
        }

        function initManualEntry() {
            state.manualEntry = {
                week: getNextWeekNumber(),
                date: getNextPlayDate(),
                homeTeamId: '',
                awayTeamId: '',
                half: 1,
                isPositionNight: false
            };
            state.showManualEntry = true;
            render();
        }

        function addManualScheduleEntry() {
            const entry = state.manualEntry;
            
            if (!entry.week || !entry.date) {
                alert('Week and date are required');
                return;
            }
            
            if (!entry.homeTeamId) {
                alert('Please select a home team');
                return;
            }
            
            const isBye = entry.awayTeamId === 'BYE';
            
            const newEntry = {
                id: Date.now().toString() + '-' + Math.random().toString(36).substr(2, 9),
                week: entry.week,
                date: entry.date,
                homeTeamId: entry.homeTeamId,
                awayTeamId: isBye ? 'BYE' : entry.awayTeamId,
                venue: isBye ? 'BYE WEEK' : (state.teams.find(t => t.id === entry.homeTeamId)?.venue || 'TBD'),
                isBye: isBye,
                half: parseInt(entry.half) || 1,
                isPositionNight: entry.isPositionNight
            };
            
            if (entry.isPositionNight) {
                // For position night, store position numbers instead of team IDs
                const homePos = parseInt(entry.homeTeamId);
                const awayPos = isBye ? null : parseInt(entry.awayTeamId);
                newEntry.homeTeamId = `POSITION_${homePos}`;
                newEntry.awayTeamId = isBye ? 'BYE' : `POSITION_${awayPos}`;
                newEntry.positionHome = homePos;
                newEntry.positionAway = awayPos;
                newEntry.venue = isBye ? 'BYE WEEK' : 'TBD - Based on Standings';
            }
            
            const newSchedule = [...state.schedule, newEntry].sort((a, b) => {
                const weekDiff = parseInt(a.week) - parseInt(b.week);
                if (weekDiff !== 0) return weekDiff;
                return new Date(a.date) - new Date(b.date);
            });
            
            saveSchedule(newSchedule);
            
            // Auto-advance to next entry
            state.manualEntry = {
                week: entry.week, // Keep same week for multiple matches
                date: entry.date,
                homeTeamId: '',
                awayTeamId: '',
                half: entry.half,
                isPositionNight: entry.isPositionNight
            };
            
            alert('Match added!');
            render();
        }

        function advanceToNextWeek() {
            const nextWeek = (parseInt(state.manualEntry.week) + 1).toString();
            const nextDate = getNextPlayDate(state.manualEntry.date);
            state.manualEntry.week = nextWeek;
            state.manualEntry.date = nextDate;
            render();
        }

        // Auth functions
        function login(username, password) {
            const user = state.users.find(u => u.username === username && u.password === password);
            if (user) {
                state.currentUser = user;
                render();
                return true;
            }
            return false;
        }

        function logout() {
            state.currentUser = null;
            state.activeTab = 'schedule';
            render();
        }

        function createAccount(username, password, phone, role = null) {
            if (!username || !password) { alert('Username and password required'); return false; }
            if (!phone || phone.length < 10) { alert('Valid phone number required (10+ digits)'); return false; }
            if (state.users.find(u => u.username === username)) { alert('Username already exists'); return false; }

            const newUser = {
                id: Date.now().toString(),
                username, password, phone,
                role: role || (state.users.length === 0 ? 'admin' : 'captain'),
                teamId: null,
                createdAt: new Date().toISOString(),
                createdBy: state.currentUser?.id || 'system'
            };

            saveUsers([...state.users, newUser]);
            if (state.users.length === 1) {
                alert('Admin account created!');
                login(username, password);
            } else {
                alert(`User "${username}" created!`);
            }
            return true;
        }

        function deleteUser(userId) {
            if (userId === state.currentUser.id) { alert('Cannot delete yourself'); return; }
            const user = state.users.find(u => u.id === userId);
            if (confirm(`Delete user "${user.username}"?`)) {
                saveUsers(state.users.filter(u => u.id !== userId));
            }
        }

        function assignTeam(userId, teamId) {
            saveUsers(state.users.map(u => u.id === userId ? { ...u, teamId } : u));
        }

        // Team functions
        function createTeam(name, venue, captain, phone) {
            if (!name) { alert('Team name required'); return false; }
            const newTeam = {
                id: Date.now().toString(),
                name, venue: venue || '', captain: captain || '', phone: phone || '',
                players: []
            };
            saveTeams([...state.teams, newTeam]);
            state.showCreateTeam = false;
            alert(`Team "${name}" created!`);
            return true;
        }

        function deleteTeam(teamId) {
            const team = state.teams.find(t => t.id === teamId);
            if (confirm(`Delete team "${team.name}" and all its players?`)) {
                saveTeams(state.teams.filter(t => t.id !== teamId));
                saveUsers(state.users.map(u => u.teamId === teamId ? { ...u, teamId: null } : u));
            }
        }

        function addPlayer(teamId, playerName) {
            if (!playerName.trim()) return;
            
            const playerId = Date.now().toString();
            const updatedTeams = state.teams.map(t => {
                if (t.id === teamId) {
                    return { ...t, players: [...t.players, { id: playerId, name: playerName }] };
                }
                return t;
            });
            saveTeams(updatedTeams);
            
            // Create user account for player
            const baseUsername = playerName.toLowerCase().replace(/[^a-z0-9]/g, '');
            let username = baseUsername;
            let counter = 1;
            while (state.users.find(u => u.username === username)) {
                username = baseUsername + counter++;
            }
            
            const defaultPassword = 'pool' + Math.floor(Math.random() * 1000);
            const phone = prompt(`Enter phone number for ${playerName}:\n(Required for SMS scoresheet submissions)`);
            
            if (!phone || phone.length < 10) {
                alert('Player added but no user account created (phone required).');
                return;
            }
            
            const newUser = {
                id: playerId + '-user',
                username, password: defaultPassword, phone: phone.trim(),
                role: 'captain', teamId: teamId,
                playerId: playerId,
                createdAt: new Date().toISOString(),
                createdBy: state.currentUser.id
            };
            
            saveUsers([...state.users, newUser]);
            alert(`Player added!\n\nUsername: ${username}\nPassword: ${defaultPassword}\nPhone: ${phone}\n\nShare these credentials with ${playerName}.`);
        }

        function removePlayer(teamId, playerId) {
            const team = state.teams.find(t => t.id === teamId);
            const player = team.players.find(p => p.id === playerId);
            if (!confirm(`Remove ${player.name} from the team?`)) return;
            
            saveTeams(state.teams.map(t => t.id === teamId ? { ...t, players: t.players.filter(p => p.id !== playerId) } : t));
            
            const playerUser = state.users.find(u => u.playerId === playerId);
            if (playerUser && confirm(`Also delete user account for ${player.name}?`)) {
                saveUsers(state.users.filter(u => u.id !== playerUser.id));
            }
        }

        // Schedule functions
        function generateSchedule(startDate) {
            if (!startDate) { alert('Please select a start date'); return; }
            if (state.teams.length < 2) { alert('Need at least 2 teams'); return; }

            const numTeams = state.teams.length;
            
            // For round-robin with byes:
            // - Each team plays every other team once per half
            // - Each team gets exactly 1 bye per half
            // - Weeks per half = numTeams (each team has n-1 games + 1 bye)
            const weeksPerHalf = numTeams;
            const totalWeeks = (weeksPerHalf * 2) + 2; // +2 for position nights
            
            console.log(`Generating schedule: ${numTeams} teams, ${weeksPerHalf} weeks per half, ${totalWeeks} total weeks (includes 2 position nights)`);

            const schedule = generateRoundRobinSchedule(startDate, weeksPerHalf);
            
            if (!schedule) {
                alert('Could not generate a valid schedule. Please try again.');
                return;
            }

            console.log('Saving schedule with', schedule.length, 'entries');
            saveSchedule(schedule);
            state.showGenSchedule = false;
            console.log('Schedule saved, state.schedule now has', state.schedule.length, 'entries');
            alert(`Schedule generated successfully!\n\n${totalWeeks} weeks created:\n‚Ä¢ ${weeksPerHalf} weeks (1st half)\n‚Ä¢ 1 Position Night\n‚Ä¢ ${weeksPerHalf} weeks (2nd half)\n‚Ä¢ 1 Position Night (Finals)`);
            render();
        }

        function generateRoundRobinSchedule(startDate, weeksPerHalf) {
            const teams = [...state.teams];
            const numTeams = teams.length;
            const newSchedule = [];
            let currentDate = new Date(startDate);
            
            // Use circle method for round-robin scheduling
            // Add a "BYE" placeholder team to handle byes naturally
            const teamList = [...teams];
            teamList.push({ id: 'BYE_PLACEHOLDER', name: 'BYE', venue: 'BYE WEEK' });
            
            const n = teamList.length; // Now has an extra "BYE" team
            const rounds = n - 1; // Number of rounds = weeks per half
            
            // Track home/away assignments for first half to reverse in second half
            const firstHalfHomeAway = {}; // key: "teamA-teamB", value: homeTeamId
            
            for (let half = 1; half <= 2; half++) {
                // Create a copy of team list for rotation
                const rotating = [...teamList];
                
                // Generate rounds using circle method
                for (let round = 0; round < rounds; round++) {
                    const weekNum = half === 1 ? round + 1 : weeksPerHalf + 2 + round;
                    const weekMatches = []; // Collect matches for this week first
                    const venuesUsedThisWeek = new Set();
                    
                    // Pair up teams: first with last, second with second-to-last, etc.
                    for (let i = 0; i < n / 2; i++) {
                        const team1 = rotating[i];
                        const team2 = rotating[n - 1 - i];
                        
                        // Skip if both are the BYE placeholder (shouldn't happen)
                        if (team1.id === 'BYE_PLACEHOLDER' && team2.id === 'BYE_PLACEHOLDER') continue;
                        
                        // Handle bye week
                        if (team1.id === 'BYE_PLACEHOLDER') {
                            weekMatches.push({
                                id: `${Date.now()}-${weekNum}-bye-${team2.id}-${Math.random()}`,
                                week: weekNum.toString(),
                                date: currentDate.toISOString().split('T')[0],
                                homeTeamId: team2.id,
                                awayTeamId: 'BYE',
                                venue: 'BYE WEEK',
                                isBye: true,
                                half: half,
                                isPositionNight: false
                            });
                            continue;
                        }
                        
                        if (team2.id === 'BYE_PLACEHOLDER') {
                            weekMatches.push({
                                id: `${Date.now()}-${weekNum}-bye-${team1.id}-${Math.random()}`,
                                week: weekNum.toString(),
                                date: currentDate.toISOString().split('T')[0],
                                homeTeamId: team1.id,
                                awayTeamId: 'BYE',
                                venue: 'BYE WEEK',
                                isBye: true,
                                half: half,
                                isPositionNight: false
                            });
                            continue;
                        }
                        
                        // Regular match - determine home/away
                        let home, away;
                        const matchKey = [team1.id, team2.id].sort().join('-');
                        
                        if (half === 1) {
                            // First half: alternate based on round and position
                            if ((round + i) % 2 === 0) {
                                home = team1;
                                away = team2;
                            } else {
                                home = team2;
                                away = team1;
                            }
                            // Store for second half reversal
                            firstHalfHomeAway[matchKey] = home.id;
                        } else {
                            // Second half: reverse home/away from first half
                            const firstHalfHome = firstHalfHomeAway[matchKey];
                            if (firstHalfHome === team1.id) {
                                home = team2;
                                away = team1;
                            } else {
                                home = team1;
                                away = team2;
                            }
                        }
                        
                        weekMatches.push({
                            home: home,
                            away: away,
                            matchKey: matchKey
                        });
                    }
                    
                    // Now resolve venue conflicts for this week
                    const resolvedMatches = resolveVenueConflicts(weekMatches, weekNum, currentDate, half, firstHalfHomeAway);
                    newSchedule.push(...resolvedMatches);
                    
                    currentDate.setDate(currentDate.getDate() + 7);
                    
                    // Rotate: keep first team fixed, rotate the rest
                    const last = rotating.pop();
                    rotating.splice(1, 0, last);
                }

                // Add Position Night after this half
                const positionNightWeek = half === 1 ? weeksPerHalf + 1 : (weeksPerHalf * 2) + 2;
                const numPositionMatches = Math.floor(numTeams / 2);

                for (let pos = 0; pos < numPositionMatches; pos++) {
                    const position1 = (pos * 2) + 1;
                    const position2 = (pos * 2) + 2;
                    
                    newSchedule.push({
                        id: `${Date.now()}-pos-${half}-${pos}-${Math.random()}`,
                        week: positionNightWeek.toString(),
                        date: currentDate.toISOString().split('T')[0],
                        homeTeamId: `POSITION_${position1}`,
                        awayTeamId: `POSITION_${position2}`,
                        venue: 'TBD - Based on Standings',
                        isBye: false,
                        half: half,
                        isPositionNight: true,
                        positionHome: position1,
                        positionAway: position2
                    });
                }

                // If odd number of teams, last place gets a bye on position night
                if (numTeams % 2 === 1) {
                    newSchedule.push({
                        id: `${Date.now()}-pos-${half}-bye-${Math.random()}`,
                        week: positionNightWeek.toString(),
                        date: currentDate.toISOString().split('T')[0],
                        homeTeamId: `POSITION_${numTeams}`,
                        awayTeamId: 'BYE',
                        venue: 'BYE WEEK',
                        isBye: true,
                        half: half,
                        isPositionNight: true,
                        positionHome: numTeams
                    });
                }

                currentDate.setDate(currentDate.getDate() + 7);
            }
            
            // Sort schedule by week number
            newSchedule.sort((a, b) => parseInt(a.week) - parseInt(b.week));
            
            // Verify the schedule
            console.log(`Generated ${newSchedule.length} total entries`);
            console.log(`Regular matches: ${newSchedule.filter(s => !s.isBye && !s.isPositionNight).length}`);
            console.log(`Byes: ${newSchedule.filter(s => s.isBye && !s.isPositionNight).length}`);
            console.log(`Position night matches: ${newSchedule.filter(s => s.isPositionNight).length}`);
            
            // Check for venue conflicts
            const venueConflicts = checkVenueConflicts(newSchedule);
            if (venueConflicts.length > 0) {
                console.warn('Venue conflicts detected:', venueConflicts);
            } else {
                console.log('‚úî No venue conflicts detected!');
            }
            
            // Validate home/away balance and matchup completeness
            const validation = validateSchedule(newSchedule, teams);
            if (validation.errors.length > 0) {
                console.error('Schedule validation errors:', validation.errors);
            } else {
                console.log('‚úî Schedule validation passed!');
            }
            console.log('Validation details:', validation);
            
            return newSchedule;
        }

        // Validate that each team plays every other team once per half, once home and once away overall
        function validateSchedule(schedule, teams) {
            const errors = [];
            const matchups = {}; // key: "teamA-teamB", value: { firstHalf: {home, away}, secondHalf: {home, away} }
            
            // Initialize matchup tracking
            for (let i = 0; i < teams.length; i++) {
                for (let j = i + 1; j < teams.length; j++) {
                    const key = [teams[i].id, teams[j].id].sort().join('-');
                    matchups[key] = {
                        teams: [teams[i].name, teams[j].name],
                        firstHalf: { count: 0, homeTeam: null },
                        secondHalf: { count: 0, homeTeam: null }
                    };
                }
            }
            
            // Count matchups from schedule
            const regularMatches = schedule.filter(s => !s.isBye && !s.isPositionNight);
            
            for (const match of regularMatches) {
                const key = [match.homeTeamId, match.awayTeamId].sort().join('-');
                if (!matchups[key]) continue; // Skip if not a valid team matchup
                
                const half = match.half === 1 ? 'firstHalf' : 'secondHalf';
                matchups[key][half].count++;
                matchups[key][half].homeTeam = match.homeTeamId;
            }
            
            // Validate each matchup
            for (const [key, data] of Object.entries(matchups)) {
                // Check first half
                if (data.firstHalf.count !== 1) {
                    errors.push(`${data.teams.join(' vs ')}: Expected 1 match in first half, got ${data.firstHalf.count}`);
                }
                // Check second half
                if (data.secondHalf.count !== 1) {
                    errors.push(`${data.teams.join(' vs ')}: Expected 1 match in second half, got ${data.secondHalf.count}`);
                }
                // Check home/away reversal
                if (data.firstHalf.homeTeam && data.secondHalf.homeTeam && 
                    data.firstHalf.homeTeam === data.secondHalf.homeTeam) {
                    errors.push(`${data.teams.join(' vs ')}: Same team (${data.firstHalf.homeTeam}) is home in both halves!`);
                }
            }
            
            // Check each team's home/away count
            const homeCount = {};
            const awayCount = {};
            teams.forEach(t => { homeCount[t.id] = 0; awayCount[t.id] = 0; });
            
            for (const match of regularMatches) {
                if (homeCount[match.homeTeamId] !== undefined) homeCount[match.homeTeamId]++;
                if (awayCount[match.awayTeamId] !== undefined) awayCount[match.awayTeamId]++;
            }
            
            const expectedGames = (teams.length - 1) * 2; // Play each other team twice
            const expectedHome = teams.length - 1; // Home once against each team
            const expectedAway = teams.length - 1; // Away once against each team
            
            for (const team of teams) {
                const totalGames = homeCount[team.id] + awayCount[team.id];
                if (totalGames !== expectedGames) {
                    errors.push(`${team.name}: Expected ${expectedGames} total games, got ${totalGames}`);
                }
                if (homeCount[team.id] !== expectedHome) {
                    errors.push(`${team.name}: Expected ${expectedHome} home games, got ${homeCount[team.id]}`);
                }
                if (awayCount[team.id] !== expectedAway) {
                    errors.push(`${team.name}: Expected ${expectedAway} away games, got ${awayCount[team.id]}`);
                }
            }
            
            return {
                errors,
                matchupCount: Object.keys(matchups).length,
                totalMatches: regularMatches.length,
                homeGamesPerTeam: homeCount,
                awayGamesPerTeam: awayCount
            };
        }

        // Resolve venue conflicts by swapping home/away when possible
        function resolveVenueConflicts(weekMatches, weekNum, currentDate, half, firstHalfHomeAway) {
            const resolved = [];
            const venuesUsed = new Set();
            
            // First, add all bye weeks (no venue conflict)
            for (const match of weekMatches) {
                if (match.isBye) {
                    resolved.push(match);
                }
            }
            
            // Then process regular matches
            const regularMatches = weekMatches.filter(m => !m.isBye && m.home);
            
            for (const match of regularMatches) {
                let home = match.home;
                let away = match.away;
                const homeVenue = (home.venue || '').toLowerCase().trim();
                const awayVenue = (away.venue || '').toLowerCase().trim();
                
                // Check if home venue is already used
                if (homeVenue && homeVenue !== 'tbd' && venuesUsed.has(homeVenue)) {
                    // Try swapping home/away
                    if (!awayVenue || awayVenue === 'tbd' || !venuesUsed.has(awayVenue)) {
                        // Swap is possible
                        console.log(`Week ${weekNum}: Swapping ${home.name} <-> ${away.name} due to venue conflict at ${homeVenue}`);
                        const temp = home;
                        home = away;
                        away = temp;
                        
                        // Update firstHalfHomeAway if in first half
                        if (half === 1) {
                            firstHalfHomeAway[match.matchKey] = home.id;
                        }
                    } else {
                        console.warn(`Week ${weekNum}: Cannot resolve venue conflict for ${home.name} vs ${away.name}. Both venues (${homeVenue}, ${awayVenue}) are in use.`);
                    }
                }
                
                // Mark venue as used
                const finalVenue = (home.venue || '').toLowerCase().trim();
                if (finalVenue && finalVenue !== 'tbd') {
                    venuesUsed.add(finalVenue);
                }
                
                resolved.push({
                    id: `${Date.now()}-${weekNum}-${home.id}-${away.id}-${Math.random()}`,
                    week: weekNum.toString(),
                    date: currentDate.toISOString().split('T')[0],
                    homeTeamId: home.id,
                    awayTeamId: away.id,
                    venue: home.venue || 'TBD',
                    isBye: false,
                    half: half,
                    isPositionNight: false
                });
            }
            
            return resolved;
        }

        // Check for any remaining venue conflicts in the final schedule
        function checkVenueConflicts(schedule) {
            const conflicts = [];
            const weeks = [...new Set(schedule.map(s => s.week))];
            
            for (const week of weeks) {
                const weekMatches = schedule.filter(s => s.week === week && !s.isBye && !s.isPositionNight);
                const venueCount = {};
                
                for (const match of weekMatches) {
                    const venue = (match.venue || '').toLowerCase().trim();
                    if (venue && venue !== 'tbd' && venue !== 'tbd - based on standings') {
                        venueCount[venue] = (venueCount[venue] || 0) + 1;
                        if (venueCount[venue] > 1) {
                            conflicts.push({ week, venue, match });
                        }
                    }
                }
            }
            
            return conflicts;
        }

        // Function to resolve position night matchups based on current standings
        function getResolvedPositionTeam(positionId, half) {
            if (!positionId || !positionId.startsWith('POSITION_')) return null;
            
            const position = parseInt(positionId.replace('POSITION_', ''));
            const standings = calcStandingsForHalf(half);
            
            if (position <= standings.length) {
                return standings[position - 1];
            }
            return null;
        }

        // Calculate standings up to a specific half (for position night resolution)
        function calcStandingsForHalf(upToHalf) {
            const standings = state.teams.map(t => ({ 
                id: t.id, 
                name: t.name, 
                venue: t.venue,
                wins: 0, 
                losses: 0, 
                gamesWon: 0, 
                gamesLost: 0 
            }));
            
            state.matches.forEach(match => {
                const sched = state.schedule.find(s => s.id === match.scheduleId);
                if (!sched) return;
                if (sched.half > upToHalf || sched.isPositionNight) return;
                
                let homeTeamId = sched.homeTeamId;
                let awayTeamId = sched.awayTeamId;
                
                const hIdx = standings.findIndex(s => s.id === homeTeamId);
                const aIdx = standings.findIndex(s => s.id === awayTeamId);
                if (hIdx !== -1 && aIdx !== -1) {
                    standings[hIdx].gamesWon += match.homeScore;
                    standings[hIdx].gamesLost += match.awayScore;
                    standings[aIdx].gamesWon += match.awayScore;
                    standings[aIdx].gamesLost += match.homeScore;
                    if (match.homeScore > match.awayScore) { 
                        standings[hIdx].wins++; 
                        standings[aIdx].losses++; 
                    } else { 
                        standings[aIdx].wins++; 
                        standings[hIdx].losses++; 
                    }
                }
            });

            // Bye week points
            state.schedule.filter(s => s.isBye && !s.isPositionNight && s.half <= upToHalf).forEach(s => {
                const idx = standings.findIndex(st => st.id === s.homeTeamId);
                if (idx !== -1) standings[idx].gamesWon += 5;
            });

            return standings.sort((a, b) => b.wins - a.wins || b.gamesWon - a.gamesWon);
        }

        function deleteScheduleMatch(matchId) {
            if (confirm('Delete this match?')) {
                saveSchedule(state.schedule.filter(m => m.id !== matchId));
                saveSubmissions(state.submissions.filter(s => s.scheduleId !== matchId));
                saveMatches(state.matches.filter(m => m.scheduleId !== matchId));
            }
        }

        // Score submission
        function submitScores() {
            const sel = state.selectedMatch;
            const team = state.selectedTeam;
            const matchups = state.matchups;
            const isAdmin = state.currentUser.role === 'admin';

            if (!sel) { alert('Select a match'); return; }
            
            // Non-admins must select their team for dual-submission workflow
            if (!isAdmin && !team) { alert('Select your team'); return; }

            for (let i = 0; i < matchups.length; i++) {
                const m = matchups[i];
                const hg = parseInt(m.homeGames) || 0;
                const ag = parseInt(m.awayGames) || 0;
                if (!m.homePlayer || !m.awayPlayer) { alert(`Game ${i + 1}: Select both players`); return; }
                if (!((hg === 2 && ag <= 1) || (ag === 2 && hg <= 1))) {
                    alert(`Game ${i + 1}: One player must win 2, other 0 or 1`); return;
                }
            }

            const homeScore = matchups.filter(m => parseInt(m.homeGames) > parseInt(m.awayGames)).length;
            const awayScore = matchups.filter(m => parseInt(m.awayGames) > parseInt(m.homeGames)).length;

            // ADMIN: Direct posting - no dual submission needed
            if (isAdmin) {
                const match = {
                    scheduleId: sel,
                    homeScore,
                    awayScore,
                    matchups: matchups.map(m => ({ ...m })),
                    approved: true,
                    approvedBy: state.currentUser.id,
                    timestamp: new Date().toISOString()
                };
                saveMatches([...state.matches, match]);
                // Clear any pending submissions for this match
                saveSubmissions(state.submissions.filter(s => s.scheduleId !== sel));
                alert('Scores posted!');
            } else {
                // CAPTAIN: Dual submission workflow
                if (state.submissions.find(s => s.scheduleId === sel && s.teamId === team)) {
                    alert('Your team already submitted scores for this match'); return;
                }

                const sub = {
                    id: Date.now().toString(),
                    scheduleId: sel, teamId: team,
                    homeScore, awayScore,
                    matchups: matchups.map(m => ({ ...m })),
                    timestamp: new Date().toISOString()
                };

                const newSubs = [...state.submissions, sub];
                const otherSub = state.submissions.find(s => s.scheduleId === sel && s.teamId !== team);

                if (otherSub) {
                    if (sub.homeScore === otherSub.homeScore && sub.awayScore === otherSub.awayScore) {
                        const comp = { scheduleId: sel, homeScore, awayScore, matchups: sub.matchups, approved: true, timestamp: new Date().toISOString() };
                        saveMatches([...state.matches, comp]);
                        saveSubmissions(newSubs.filter(s => s.scheduleId !== sel));
                        alert('Scores match! Result approved.');
                    } else {
                        saveSubmissions(newSubs);
                        alert('Scores submitted but conflict detected. Needs admin review.');
                    }
                } else {
                    saveSubmissions(newSubs);
                    alert('Submitted! Waiting for other team.');
                }
            }

            state.selectedMatch = '';
            state.selectedTeam = '';
            state.matchups = Array(5).fill(null).map(() => ({ homePlayer: '', awayPlayer: '', homeGames: '', awayGames: '' }));
            render();
        }

        // Helper function for ordinal numbers (1st, 2nd, 3rd, etc.)
        function getOrdinal(n) {
            const s = ['th', 'st', 'nd', 'rd'];
            const v = n % 100;
            return (s[(v - 20) % 10] || s[v] || s[0]);
        }

        // Calculate standings (overall)
        function calcStandings() {
            const standings = state.teams.map(t => ({ id: t.id, name: t.name, wins: 0, losses: 0, gamesWon: 0, gamesLost: 0 }));
            
            state.matches.forEach(match => {
                const sched = state.schedule.find(s => s.id === match.scheduleId);
                if (!sched) return;
                
                // For position night matches, we need to resolve the team IDs
                let homeTeamId = sched.homeTeamId;
                let awayTeamId = sched.awayTeamId;
                
                if (sched.isPositionNight) {
                    const resolvedHome = getResolvedPositionTeam(sched.homeTeamId, sched.half);
                    const resolvedAway = getResolvedPositionTeam(sched.awayTeamId, sched.half);
                    if (resolvedHome) homeTeamId = resolvedHome.id;
                    if (resolvedAway) awayTeamId = resolvedAway.id;
                }
                
                const hIdx = standings.findIndex(s => s.id === homeTeamId);
                const aIdx = standings.findIndex(s => s.id === awayTeamId);
                if (hIdx !== -1 && aIdx !== -1) {
                    standings[hIdx].gamesWon += match.homeScore;
                    standings[hIdx].gamesLost += match.awayScore;
                    standings[aIdx].gamesWon += match.awayScore;
                    standings[aIdx].gamesLost += match.homeScore;
                    if (match.homeScore > match.awayScore) { standings[hIdx].wins++; standings[aIdx].losses++; }
                    else { standings[aIdx].wins++; standings[hIdx].losses++; }
                }
            });

            // Bye week points (excluding position night byes)
            state.schedule.filter(s => s.isBye && !s.isPositionNight).forEach(s => {
                const idx = standings.findIndex(st => st.id === s.homeTeamId);
                if (idx !== -1) standings[idx].gamesWon += 5;
            });

            return standings.sort((a, b) => b.wins - a.wins || b.gamesWon - a.gamesWon);
        }

        // Calculate player stats
        function calcPlayerStats() {
            const stats = [];
            state.teams.forEach(team => {
                team.players.forEach(player => {
                    stats.push({ id: player.id, name: player.name, team: team.name, matchWins: 0, matchLosses: 0, gamesWon: 0, gamesLost: 0 });
                });
            });

            state.matches.forEach(match => {
                match.matchups?.forEach(mu => {
                    const hg = parseInt(mu.homeGames) || 0;
                    const ag = parseInt(mu.awayGames) || 0;
                    
                    const hp = stats.find(s => s.id === mu.homePlayer);
                    const ap = stats.find(s => s.id === mu.awayPlayer);
                    
                    if (hp) { hp.gamesWon += hg; hp.gamesLost += ag; if (hg > ag) hp.matchWins++; else hp.matchLosses++; }
                    if (ap) { ap.gamesWon += ag; ap.gamesLost += hg; if (ag > hg) ap.matchWins++; else ap.matchLosses++; }
                });
            });

            return stats.sort((a, b) => b.matchWins - a.matchWins || b.gamesWon - a.gamesWon);
        }

        // Render functions
        function renderLoginScreen() {
            const isFirstUser = state.users.length === 0;
            return `
                <div class="min-h-screen bg-gradient-to-br from-slate-900 via-emerald-900 to-teal-900 flex items-center justify-center p-4">
                    <div class="relative bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md border-4 border-emerald-700">
                        <div class="text-center mb-8">
                            <div class="text-6xl mb-4">üèÜ</div>
                            <h1 class="text-4xl font-black text-slate-800 mb-2">Pool League</h1>
                            <p class="text-slate-600">${isFirstUser ? 'Create Admin Account' : 'Sign In'}</p>
                        </div>
                        <div class="space-y-4">
                            <input type="text" id="login-username" placeholder="Username" class="w-full px-4 py-3 border-2 border-slate-300 rounded-lg">
                            <input type="password" id="login-password" placeholder="Password" class="w-full px-4 py-3 border-2 border-slate-300 rounded-lg">
                            ${isFirstUser ? `<input type="tel" id="login-phone" placeholder="Phone (required)" class="w-full px-4 py-3 border-2 border-slate-300 rounded-lg">` : ''}
                            <div id="login-error" class="hidden bg-red-50 border-2 border-red-200 text-red-700 px-4 py-3 rounded-lg"></div>
                            <button onclick="handleLogin()" class="w-full bg-gradient-to-r from-emerald-600 to-teal-600 text-white font-bold py-4 rounded-lg hover:from-emerald-700 hover:to-teal-700">
                                ${isFirstUser ? 'Create Admin Account' : 'Sign In'}
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderHeader() {
            const isAdmin = state.currentUser.role === 'admin';
            return `
                <header class="bg-gradient-to-r from-emerald-700 via-emerald-600 to-teal-600 text-white shadow-2xl">
                    <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
                        <h1 class="text-2xl md:text-4xl font-black flex items-center gap-2">üèÜ ${state.leagueName}</h1>
                        <div class="flex items-center gap-3">
                            <div class="text-right text-sm">
                                <div class="opacity-90">Logged in as</div>
                                <div class="font-bold">${isAdmin ? 'üõ°Ô∏è' : ''} ${state.currentUser.username}</div>
                            </div>
                            <button onclick="logout()" class="p-2 bg-white/20 hover:bg-white/30 rounded-lg">üö™</button>
                        </div>
                    </div>
                </header>
            `;
        }

        function renderNav() {
            const isAdmin = state.currentUser.role === 'admin';
            const tabs = [
                { id: 'schedule', label: 'üìÖ Schedule', show: true },
                { id: 'submit', label: 'üìù Submit Scores', show: true },
                { id: 'standings', label: 'üèÜ Standings', show: true },
                { id: 'players', label: 'üë§ Player Stats', show: true },
                { id: 'history', label: 'üìú History', show: true },
                { id: 'teams', label: 'üè† Teams', show: true },
                { id: 'users', label: 'üë• Users', show: true },
                { id: 'admin', label: 'üõ°Ô∏è Admin', show: isAdmin },
                { id: 'settings', label: '‚öôÔ∏è Settings', show: isAdmin }
            ].filter(t => t.show);

            return `
                <nav class="bg-white shadow-md border-b-2 border-emerald-100">
                    <div class="max-w-7xl mx-auto px-4 flex gap-1 overflow-x-auto tab-scroll">
                        ${tabs.map(tab => `
                            <button onclick="state.activeTab='${tab.id}'; render();" 
                                class="px-4 py-3 font-semibold transition-all border-b-4 whitespace-nowrap text-sm ${
                                    state.activeTab === tab.id 
                                        ? 'text-emerald-700 border-emerald-700 bg-emerald-50' 
                                        : 'text-gray-600 border-transparent hover:text-emerald-600'
                                }">
                                ${tab.label}
                            </button>
                        `).join('')}
                    </div>
                </nav>
            `;
        }

        function renderSchedule() {
            const isAdmin = state.currentUser.role === 'admin';
            const weeks = [...new Set(state.schedule.map(s => s.week))].sort((a, b) => parseInt(a) - parseInt(b));

            return `
                <div class="space-y-6">
                    <div class="bg-gradient-to-r from-emerald-600 to-teal-600 text-white rounded-xl shadow-lg p-6">
                        <h2 class="text-3xl font-black">üìÖ League Schedule</h2>
                        <p class="mt-2 opacity-90">View and manage all scheduled matches</p>
                    </div>

                    ${isAdmin ? `
                    <div class="bg-white rounded-xl shadow-lg p-6 border-2 border-emerald-100">
                        <div class="flex flex-wrap gap-4 mb-4">
                            <button onclick="state.showGenSchedule = !state.showGenSchedule; state.showManualEntry = false; render();" 
                                class="px-6 py-3 bg-gradient-to-r from-blue-600 to-blue-700 text-white font-bold rounded-lg hover:from-blue-700 hover:to-blue-800">
                                üîÑ Auto-Generate Schedule
                            </button>
                            <button onclick="initManualEntry(); state.showGenSchedule = false;" 
                                class="px-6 py-3 bg-gradient-to-r from-purple-600 to-purple-700 text-white font-bold rounded-lg hover:from-purple-700 hover:to-purple-800">
                                ‚ûï Add Match Manually
                            </button>
                        </div>
                        
                        <!-- Play Days Setting -->
                        <div class="mb-4 p-3 bg-slate-50 rounded-lg border">
                            <label class="block text-sm font-bold text-slate-700 mb-2">üìÖ League Play Days:</label>
                            <div class="flex flex-wrap gap-2">
                                ${['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map((day, i) => `
                                    <button onclick="togglePlayDay(${i})" 
                                        class="px-3 py-1 rounded-full text-sm font-semibold transition-all ${
                                            state.playDays.includes(i) 
                                                ? 'bg-emerald-600 text-white' 
                                                : 'bg-slate-200 text-slate-600 hover:bg-slate-300'
                                        }">
                                        ${day}
                                    </button>
                                `).join('')}
                            </div>
                            <p class="text-xs text-slate-500 mt-1">Selected days are used for auto-calculating dates when adding matches</p>
                        </div>

                        ${state.showManualEntry ? `
                        <div class="mt-4 p-4 bg-purple-50 rounded-lg border-2 border-purple-200">
                            <h4 class="font-bold text-purple-800 mb-4">‚ûï Add Match Manually</h4>
                            
                            <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                                <div>
                                    <label class="block text-sm font-bold text-purple-700 mb-1">Week #</label>
                                    <div class="flex gap-2">
                                        <input type="number" min="1" value="${state.manualEntry.week}" 
                                            onchange="state.manualEntry.week = this.value; render();"
                                            class="flex-1 px-3 py-2 border-2 border-purple-300 rounded-lg">
                                        <button onclick="advanceToNextWeek()" 
                                            class="px-3 py-2 bg-purple-200 text-purple-700 rounded-lg hover:bg-purple-300 text-sm font-bold"
                                            title="Advance to next week">+1</button>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-bold text-purple-700 mb-1">Date</label>
                                    <input type="date" value="${state.manualEntry.date}" 
                                        onchange="state.manualEntry.date = this.value; render();"
                                        class="w-full px-3 py-2 border-2 border-purple-300 rounded-lg">
                                </div>
                                <div>
                                    <label class="block text-sm font-bold text-purple-700 mb-1">Half</label>
                                    <select onchange="state.manualEntry.half = parseInt(this.value); render();"
                                        class="w-full px-3 py-2 border-2 border-purple-300 rounded-lg">
                                        <option value="1" ${state.manualEntry.half === 1 ? 'selected' : ''}>1st Half</option>
                                        <option value="2" ${state.manualEntry.half === 2 ? 'selected' : ''}>2nd Half</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-bold text-purple-700 mb-1">Match Type</label>
                                    <select onchange="state.manualEntry.isPositionNight = this.value === 'position'; render();"
                                        class="w-full px-3 py-2 border-2 border-purple-300 rounded-lg">
                                        <option value="regular" ${!state.manualEntry.isPositionNight ? 'selected' : ''}>Regular Match</option>
                                        <option value="position" ${state.manualEntry.isPositionNight ? 'selected' : ''}>Position Night</option>
                                    </select>
                                </div>
                            </div>

                            ${state.manualEntry.isPositionNight ? `
                            <div class="grid md:grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label class="block text-sm font-bold text-purple-700 mb-1">Home Position (Higher Seed)</label>
                                    <select onchange="state.manualEntry.homeTeamId = this.value; render();"
                                        class="w-full px-3 py-2 border-2 border-purple-300 rounded-lg">
                                        <option value="">Select position...</option>
                                        ${Array.from({length: state.teams.length}, (_, i) => i + 1).map(pos => `
                                            <option value="${pos}" ${state.manualEntry.homeTeamId === pos.toString() ? 'selected' : ''}>${pos}${getOrdinal(pos)} Place</option>
                                        `).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-bold text-purple-700 mb-1">Away Position (Lower Seed)</label>
                                    <select onchange="state.manualEntry.awayTeamId = this.value; render();"
                                        class="w-full px-3 py-2 border-2 border-purple-300 rounded-lg">
                                        <option value="">Select position...</option>
                                        ${Array.from({length: state.teams.length}, (_, i) => i + 1).map(pos => `
                                            <option value="${pos}" ${state.manualEntry.awayTeamId === pos.toString() ? 'selected' : ''}>${pos}${getOrdinal(pos)} Place</option>
                                        `).join('')}
                                        <option value="BYE" ${state.manualEntry.awayTeamId === 'BYE' ? 'selected' : ''}>BYE (Last place bye)</option>
                                    </select>
                                </div>
                            </div>
                            ` : `
                            <div class="grid md:grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label class="block text-sm font-bold text-purple-700 mb-1">Home Team</label>
                                    <select onchange="state.manualEntry.homeTeamId = this.value; render();"
                                        class="w-full px-3 py-2 border-2 border-purple-300 rounded-lg">
                                        <option value="">Select home team...</option>
                                        ${state.teams.map(t => `
                                            <option value="${t.id}" ${state.manualEntry.homeTeamId === t.id ? 'selected' : ''}>${t.name}</option>
                                        `).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-bold text-purple-700 mb-1">Away Team</label>
                                    <select onchange="state.manualEntry.awayTeamId = this.value; render();"
                                        class="w-full px-3 py-2 border-2 border-purple-300 rounded-lg">
                                        <option value="">Select away team...</option>
                                        ${state.teams.filter(t => t.id !== state.manualEntry.homeTeamId).map(t => `
                                            <option value="${t.id}" ${state.manualEntry.awayTeamId === t.id ? 'selected' : ''}>${t.name}</option>
                                        `).join('')}
                                        <option value="BYE" ${state.manualEntry.awayTeamId === 'BYE' ? 'selected' : ''}>BYE WEEK</option>
                                    </select>
                                </div>
                            </div>
                            `}

                            <!-- Preview -->
                            <div class="bg-white p-3 rounded-lg border mb-4">
                                <span class="text-sm font-bold text-slate-600">Preview: </span>
                                <span class="text-slate-800">
                                    Week ${state.manualEntry.week} (${state.manualEntry.half === 1 ? '1st' : '2nd'} Half) - ${state.manualEntry.date || 'No date'}: 
                                    ${state.manualEntry.isPositionNight ? 
                                        (state.manualEntry.awayTeamId === 'BYE' ? 
                                            `üèÜ ${state.manualEntry.homeTeamId}${getOrdinal(parseInt(state.manualEntry.homeTeamId) || 0)} Place - BYE` :
                                            `üèÜ ${state.manualEntry.awayTeamId}${getOrdinal(parseInt(state.manualEntry.awayTeamId) || 0)} Place @ ${state.manualEntry.homeTeamId}${getOrdinal(parseInt(state.manualEntry.homeTeamId) || 0)} Place`) :
                                        (state.manualEntry.awayTeamId === 'BYE' ?
                                            `üèñÔ∏è ${state.teams.find(t => t.id === state.manualEntry.homeTeamId)?.name || '?'} - BYE WEEK` :
                                            `${state.teams.find(t => t.id === state.manualEntry.awayTeamId)?.name || '?'} @ ${state.teams.find(t => t.id === state.manualEntry.homeTeamId)?.name || '?'}`)
                                    }
                                </span>
                            </div>

                            <div class="flex gap-3">
                                <button onclick="addManualScheduleEntry()" 
                                    class="px-6 py-2 bg-purple-600 text-white font-bold rounded-lg hover:bg-purple-700">
                                    ‚ûï Add Match
                                </button>
                                <button onclick="state.showManualEntry = false; render();" 
                                    class="px-6 py-2 bg-slate-300 text-slate-700 font-bold rounded-lg hover:bg-slate-400">
                                    Cancel
                                </button>
                            </div>
                        </div>
                        ` : ''}
                        ${state.showGenSchedule ? `
                        <div class="mt-4 p-4 bg-blue-50 rounded-lg border-2 border-blue-200">
                            <h4 class="font-bold text-blue-800 mb-2">Schedule Rules:</h4>
                            <ul class="text-sm text-blue-700 mb-4 space-y-1">
                                <li>‚úî <strong>1 bye per week</strong> - Exactly one team has a bye each week</li>
                                <li>‚úî <strong>2 byes per team</strong> - One in first half, one in second half</li>
                                <li>‚úî <strong>Play each team once per half</strong> - Home & away across the season</li>
                                <li>‚úî <strong>2 Position Nights</strong> - After each half (1st vs 2nd, 3rd vs 4th, etc.)</li>
                                <li>‚úî <strong>Higher seed hosts</strong> - On Position Night, better ranked team is home</li>
                            </ul>
                            <div class="bg-purple-50 p-3 rounded-lg border border-purple-200 mb-4">
                                <h5 class="font-bold text-purple-800 text-sm">üèÜ Position Night</h5>
                                <p class="text-xs text-purple-700">Teams are matched by standings: 1st plays 2nd, 3rd plays 4th, etc. Position Night matches show as placeholders until regular season standings are finalized.</p>
                            </div>
                            <div class="flex gap-2 items-center">
                                <label class="font-semibold text-blue-800">Start Date:</label>
                                <input type="date" id="gen-start-date" class="px-4 py-2 border-2 border-blue-300 rounded-lg">
                                <button onclick="generateSchedule(document.getElementById('gen-start-date').value)" 
                                    class="px-6 py-2 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700">Generate</button>
                            </div>
                            <p class="text-xs text-blue-600 mt-2">‚ö†Ô∏è This will replace any existing schedule</p>
                            <p class="text-xs text-slate-500 mt-1">Total weeks: ${state.teams.length * 2 + 2} (${state.teams.length} weeks √ó 2 halves + 2 Position Nights)</p>
                        </div>
                        ` : ''}
                    </div>
                    ` : ''}

                    ${state.schedule.length === 0 ? `
                        <div class="bg-white rounded-xl shadow-lg p-12 text-center">
                            <div class="text-6xl mb-4">üìÖ</div>
                            <h3 class="text-2xl font-bold text-slate-800 mb-2">No Schedule Yet</h3>
                            <p class="text-slate-600">${isAdmin ? 'Use Auto-Generate to create a schedule' : 'Check back later for the schedule'}</p>
                        </div>
                    ` : `
                        <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                            <table class="w-full">
                                <thead class="bg-slate-100">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-sm font-bold">Week</th>
                                        <th class="px-4 py-3 text-left text-sm font-bold">Half</th>
                                        <th class="px-4 py-3 text-left text-sm font-bold">Date</th>
                                        <th class="px-4 py-3 text-left text-sm font-bold">Matchup</th>
                                        <th class="px-4 py-3 text-left text-sm font-bold">Venue</th>
                                        <th class="px-4 py-3 text-left text-sm font-bold">Status</th>
                                        ${isAdmin ? '<th class="px-4 py-3 text-left text-sm font-bold">Action</th>' : ''}
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-200">
                                    ${state.schedule.map(match => {
                                        try {
                                        let home, away, matchupDisplay, venueDisplay;
                                        
                                        if (match.isPositionNight) {
                                            // Position Night - resolve teams from standings
                                            const resolvedHome = getResolvedPositionTeam(match.homeTeamId, match.half);
                                            const resolvedAway = getResolvedPositionTeam(match.awayTeamId, match.half);
                                            
                                            home = resolvedHome;
                                            away = resolvedAway;
                                            
                                            if (match.isBye) {
                                                // Last place bye on position night
                                                const posNum = match.positionHome || 0;
                                                if (resolvedHome) {
                                                    matchupDisplay = `<span class="text-purple-600 font-semibold">üèñÔ∏è ${resolvedHome.name} (${posNum}${getOrdinal(posNum)} place) - BYE</span>`;
                                                } else {
                                                    matchupDisplay = `<span class="text-purple-600 font-semibold">üèñÔ∏è ${posNum}${getOrdinal(posNum)} Place - BYE</span>`;
                                                }
                                                venueDisplay = '-';
                                            } else if (resolvedHome && resolvedAway) {
                                                // Both teams resolved
                                                matchupDisplay = `<span class="text-purple-700 font-bold">üèÜ #${match.positionAway} ${resolvedAway.name}</span> @ <span class="text-purple-700 font-bold">#${match.positionHome} ${resolvedHome.name}</span>`;
                                                venueDisplay = resolvedHome.venue || 'TBD';
                                            } else {
                                                // Placeholder display
                                                matchupDisplay = `<span class="text-purple-500 italic">üèÜ ${match.positionAway}${getOrdinal(match.positionAway)} Place @ ${match.positionHome}${getOrdinal(match.positionHome)} Place</span>`;
                                                venueDisplay = '<span class="text-slate-400 italic">TBD</span>';
                                            }
                                        } else {
                                            // Regular match
                                            home = state.teams.find(t => t.id === match.homeTeamId);
                                            away = state.teams.find(t => t.id === match.awayTeamId);
                                            
                                            if (match.isBye) {
                                                matchupDisplay = `<span class="text-blue-600 font-semibold">üèñÔ∏è ${home?.name || 'Unknown'} - BYE WEEK</span>`;
                                                venueDisplay = '-';
                                            } else {
                                                matchupDisplay = `<span class="font-semibold">${away?.name || '?'}</span> @ <span class="font-semibold">${home?.name || '?'}</span>`;
                                                venueDisplay = match.venue || 'TBD';
                                            }
                                        }
                                        
                                        const result = state.matches.find(m => m.scheduleId === match.id);
                                        const subs = state.submissions.filter(s => s.scheduleId === match.id);
                                        
                                        let status = '<span class="px-2 py-1 bg-gray-100 text-gray-600 rounded-full text-xs">Pending</span>';
                                        if (match.isBye) status = '<span class="px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-xs">BYE</span>';
                                        else if (result) status = `<span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs font-bold">Final: ${result.awayScore}-${result.homeScore}</span>`;
                                        else if (subs.length === 2) status = '<span class="px-2 py-1 bg-yellow-100 text-yellow-800 rounded-full text-xs">‚ö†Ô∏è Conflict</span>';
                                        else if (subs.length === 1) status = '<span class="px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-xs">1/2 Submitted</span>';
                                        else if (match.isPositionNight && !home) status = '<span class="px-2 py-1 bg-purple-100 text-purple-800 rounded-full text-xs">Awaiting Standings</span>';

                                        let halfDisplay;
                                        if (match.isPositionNight) {
                                            halfDisplay = `<span class="px-2 py-1 bg-purple-200 text-purple-900 rounded text-xs font-bold">üèÜ Position Night</span>`;
                                        } else {
                                            halfDisplay = match.half ? `<span class="px-2 py-1 ${match.half === 1 ? 'bg-purple-100 text-purple-800' : 'bg-orange-100 text-orange-800'} rounded text-xs font-bold">${match.half === 1 ? '1st' : '2nd'}</span>` : '-';
                                        }

                                        const rowClass = match.isPositionNight ? 'bg-purple-50 hover:bg-purple-100' : (match.isBye ? 'bg-blue-50 hover:bg-blue-100' : 'hover:bg-slate-50');

                                        return `
                                            <tr class="${rowClass}">
                                                <td class="px-4 py-3 font-bold">${match.week}</td>
                                                <td class="px-4 py-3">${halfDisplay}</td>
                                                <td class="px-4 py-3">${match.date}</td>
                                                <td class="px-4 py-3">${matchupDisplay}</td>
                                                <td class="px-4 py-3 text-slate-600">${venueDisplay}</td>
                                                <td class="px-4 py-3">${status}</td>
                                                ${isAdmin ? `<td class="px-4 py-3">${!match.isBye ? `<button onclick="deleteScheduleMatch('${match.id}')" class="text-red-600 hover:text-red-800 text-sm">Delete</button>` : ''}</td>` : ''}
                                            </tr>
                                        `;
                                        } catch(e) {
                                            console.error('Error rendering match:', match, e);
                                            return '<tr><td colspan="7" class="text-red-600">Error rendering match</td></tr>';
                                        }
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>

                        <div class="bg-white rounded-xl shadow-lg p-6">
                            <h3 class="text-lg font-bold mb-4">üìä Schedule Summary</h3>
                            <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                                <div class="bg-slate-50 p-4 rounded-lg text-center">
                                    <div class="text-2xl font-bold text-slate-800">${[...new Set(state.schedule.map(s => s.week))].length}</div>
                                    <div class="text-sm text-slate-600">Total Weeks</div>
                                </div>
                                <div class="bg-slate-50 p-4 rounded-lg text-center">
                                    <div class="text-2xl font-bold text-slate-800">${state.schedule.filter(s => !s.isBye && !s.isPositionNight).length}</div>
                                    <div class="text-sm text-slate-600">Regular Matches</div>
                                </div>
                                <div class="bg-purple-50 p-4 rounded-lg text-center">
                                    <div class="text-2xl font-bold text-purple-800">${state.schedule.filter(s => s.isPositionNight && !s.isBye).length}</div>
                                    <div class="text-sm text-purple-600">Position Matches</div>
                                </div>
                                <div class="bg-blue-50 p-4 rounded-lg text-center">
                                    <div class="text-2xl font-bold text-blue-800">${state.schedule.filter(s => s.isBye).length}</div>
                                    <div class="text-sm text-blue-600">Total Byes</div>
                                </div>
                                <div class="bg-green-50 p-4 rounded-lg text-center">
                                    <div class="text-2xl font-bold text-green-600">${state.matches.length}</div>
                                    <div class="text-sm text-green-600">Completed</div>
                                </div>
                            </div>
                            
                            <h4 class="text-md font-bold mt-6 mb-3">Byes Per Team (1st Half / 2nd Half):</h4>
                            <div class="flex flex-wrap gap-2">
                                ${state.teams.map(team => {
                                    const teamByes = state.schedule.filter(s => s.isBye && s.homeTeamId === team.id && !s.isPositionNight);
                                    const firstHalfByes = teamByes.filter(b => b.half === 1).length;
                                    const secondHalfByes = teamByes.filter(b => b.half === 2).length;
                                    return `
                                        <div class="bg-slate-100 px-3 py-2 rounded-lg text-sm">
                                            <span class="font-semibold">${team.name}:</span>
                                            <span class="text-purple-600">${firstHalfByes}</span> / 
                                            <span class="text-orange-600">${secondHalfByes}</span>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `}
                </div>
            `;
        }

        function renderSubmitScores() {
            const isAdmin = state.currentUser.role === 'admin';
            // Get available matches - exclude byes and completed matches
            // For position night, only show if teams are resolved
            const availMatches = state.schedule.filter(m => {
                if (m.isBye) return false;
                if (state.matches.find(x => x.scheduleId === m.id)) return false;
                
                if (m.isPositionNight) {
                    // Only show position night if teams are resolved
                    const resolvedHome = getResolvedPositionTeam(m.homeTeamId, m.half);
                    const resolvedAway = getResolvedPositionTeam(m.awayTeamId, m.half);
                    return resolvedHome && resolvedAway;
                }
                return true;
            });
            
            const match = state.schedule.find(m => m.id === state.selectedMatch);
            
            let home = null, away = null;
            if (match) {
                if (match.isPositionNight) {
                    home = getResolvedPositionTeam(match.homeTeamId, match.half);
                    away = getResolvedPositionTeam(match.awayTeamId, match.half);
                } else {
                    home = state.teams.find(t => t.id === match.homeTeamId);
                    away = state.teams.find(t => t.id === match.awayTeamId);
                }
            }

            // Admin can proceed with just match selected, captains need both match and team
            const canEnterScores = match && home && away && (isAdmin || state.selectedTeam);

            return `
                <div class="space-y-6">
                    <div class="bg-gradient-to-r from-emerald-600 to-teal-600 text-white rounded-xl shadow-lg p-6">
                        <h2 class="text-3xl font-black">${isAdmin ? 'üõ°Ô∏è Post' : 'üìù Submit'} Match Scores</h2>
                        <p class="mt-2 opacity-90">${isAdmin ? 'Admin mode: Scores are posted immediately' : 'Enter the results for each game'}</p>
                    </div>

                    ${isAdmin ? `
                    <div class="bg-amber-50 border-2 border-amber-200 rounded-xl p-4">
                        <p class="text-amber-800 font-semibold">üõ°Ô∏è Admin Mode</p>
                        <p class="text-amber-700 text-sm">Scores you enter will be posted immediately without requiring confirmation from both teams.</p>
                    </div>
                    ` : ''}

                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <div class="grid ${isAdmin ? '' : 'md:grid-cols-2'} gap-4 mb-6">
                            <div>
                                <label class="block text-sm font-bold mb-2">Select Match</label>
                                <select onchange="state.selectedMatch = this.value; render();" class="w-full px-4 py-3 border-2 border-slate-300 rounded-lg">
                                    <option value="">Choose match...</option>
                                    ${availMatches.map(m => {
                                        let displayText;
                                        if (m.isPositionNight) {
                                            const h = getResolvedPositionTeam(m.homeTeamId, m.half);
                                            const a = getResolvedPositionTeam(m.awayTeamId, m.half);
                                            displayText = `Week ${m.week} (Position Night): #${m.positionAway} ${a?.name} @ #${m.positionHome} ${h?.name}`;
                                        } else {
                                            const h = state.teams.find(t => t.id === m.homeTeamId);
                                            const a = state.teams.find(t => t.id === m.awayTeamId);
                                            displayText = `Week ${m.week}: ${a?.name} @ ${h?.name}`;
                                        }
                                        return `<option value="${m.id}" ${state.selectedMatch === m.id ? 'selected' : ''}>${displayText}</option>`;
                                    }).join('')}
                                </select>
                            </div>
                            ${!isAdmin ? `
                            <div>
                                <label class="block text-sm font-bold mb-2">Your Team</label>
                                <select onchange="state.selectedTeam = this.value; render();" class="w-full px-4 py-3 border-2 border-slate-300 rounded-lg">
                                    <option value="">Select team...</option>
                                    ${state.teams.map(t => `<option value="${t.id}" ${state.selectedTeam === t.id ? 'selected' : ''}>${t.name}</option>`).join('')}
                                </select>
                            </div>
                            ` : ''}
                        </div>

                        ${canEnterScores ? `
                            <div class="${match.isPositionNight ? 'bg-purple-50 border-purple-200' : 'bg-emerald-50 border-emerald-200'} p-4 rounded-lg border mb-6">
                                <h3 class="font-bold ${match.isPositionNight ? 'text-purple-800' : 'text-emerald-800'}">
                                    ${match.isPositionNight ? `üèÜ Position Night: #${match.positionAway} ` : ''}${away.name} (Away) @ ${match.isPositionNight ? `#${match.positionHome} ` : ''}${home.name} (Home)
                                </h3>
                                <p class="text-sm ${match.isPositionNight ? 'text-purple-700' : 'text-emerald-700'}">
                                    Venue: ${home.venue || 'TBD'}
                                    ${match.isPositionNight ? ' ‚Ä¢ Position Night Match' : ''}
                                </p>
                            </div>

                            ${state.matchups.map((m, i) => `
                                <div class="border rounded-lg p-4 mb-4 bg-slate-50">
                                    <h4 class="font-bold mb-3">Game ${i + 1}</h4>
                                    <div class="grid grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-xs font-bold uppercase text-slate-500 mb-1">${home.name} Player</label>
                                            <select onchange="state.matchups[${i}].homePlayer = this.value; render();" class="w-full px-3 py-2 border rounded">
                                                <option value="">Select...</option>
                                                ${home.players.map(p => `<option value="${p.id}" ${m.homePlayer === p.id ? 'selected' : ''}>${p.name}</option>`).join('')}
                                            </select>
                                            <input type="number" min="0" max="2" placeholder="Games won" value="${m.homeGames}" 
                                                onchange="state.matchups[${i}].homeGames = this.value;" class="w-full px-3 py-2 border rounded mt-2">
                                        </div>
                                        <div>
                                            <label class="block text-xs font-bold uppercase text-slate-500 mb-1">${away.name} Player</label>
                                            <select onchange="state.matchups[${i}].awayPlayer = this.value; render();" class="w-full px-3 py-2 border rounded">
                                                <option value="">Select...</option>
                                                ${away.players.map(p => `<option value="${p.id}" ${m.awayPlayer === p.id ? 'selected' : ''}>${p.name}</option>`).join('')}
                                            </select>
                                            <input type="number" min="0" max="2" placeholder="Games won" value="${m.awayGames}" 
                                                onchange="state.matchups[${i}].awayGames = this.value;" class="w-full px-3 py-2 border rounded mt-2">
                                        </div>
                                    </div>
                                </div>
                            `).join('')}

                            <button onclick="submitScores()" class="w-full ${isAdmin ? 'bg-amber-600 hover:bg-amber-700' : 'bg-emerald-600 hover:bg-emerald-700'} text-white font-bold py-4 rounded-lg">
                                ${isAdmin ? 'üõ°Ô∏è Post Scores (Final)' : 'Submit Scores'}
                            </button>
                        ` : `
                            <div class="text-center py-12 text-slate-500 border-2 border-dashed rounded-lg">
                                ${availMatches.length === 0 ? 
                                    '<p class="text-lg">No matches available for score submission.</p><p class="text-sm mt-2">Either all matches are complete, or Position Night teams haven\'t been determined yet.</p>' :
                                    (isAdmin ? 'Select a match to enter scores' : 'Select a match and your team to enter scores')
                                }
                            </div>
                        `}
                    </div>
                </div>
            `;
        }

        function renderStandings() {
            const standings = calcStandings();
            return `
                <div class="space-y-6">
                    <div class="bg-gradient-to-r from-emerald-600 to-teal-600 text-white rounded-xl shadow-lg p-6">
                        <h2 class="text-3xl font-black">üèÜ League Standings</h2>
                    </div>

                    <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                        <table class="w-full">
                            <thead class="bg-emerald-600 text-white">
                                <tr>
                                    <th class="px-4 py-3 text-left">Rank</th>
                                    <th class="px-4 py-3 text-left">Team</th>
                                    <th class="px-4 py-3 text-center">W</th>
                                    <th class="px-4 py-3 text-center">L</th>
                                    <th class="px-4 py-3 text-center">GW</th>
                                    <th class="px-4 py-3 text-center">GL</th>
                                    <th class="px-4 py-3 text-center">Win%</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y">
                                ${standings.map((t, i) => {
                                    const total = t.wins + t.losses;
                                    const pct = total > 0 ? ((t.wins / total) * 100).toFixed(1) : '0.0';
                                    return `
                                        <tr class="hover:bg-emerald-50">
                                            <td class="px-4 py-3 font-black text-emerald-600">${i + 1}</td>
                                            <td class="px-4 py-3 font-bold">${t.name}</td>
                                            <td class="px-4 py-3 text-center">${t.wins}</td>
                                            <td class="px-4 py-3 text-center">${t.losses}</td>
                                            <td class="px-4 py-3 text-center">${t.gamesWon}</td>
                                            <td class="px-4 py-3 text-center">${t.gamesLost}</td>
                                            <td class="px-4 py-3 text-center font-bold text-emerald-700">${pct}%</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function renderPlayerStats() {
            const stats = calcPlayerStats();
            return `
                <div class="space-y-6">
                    <div class="bg-gradient-to-r from-emerald-600 to-teal-600 text-white rounded-xl shadow-lg p-6">
                        <h2 class="text-3xl font-black">üë§ Player Statistics</h2>
                    </div>

                    <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                        <table class="w-full">
                            <thead class="bg-slate-100">
                                <tr>
                                    <th class="px-4 py-3 text-left">Player</th>
                                    <th class="px-4 py-3 text-left">Team</th>
                                    <th class="px-4 py-3 text-center">Match W</th>
                                    <th class="px-4 py-3 text-center">Match L</th>
                                    <th class="px-4 py-3 text-center">Games W</th>
                                    <th class="px-4 py-3 text-center">Games L</th>
                                    <th class="px-4 py-3 text-center">Win%</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y">
                                ${stats.map(p => {
                                    const total = p.matchWins + p.matchLosses;
                                    const pct = total > 0 ? ((p.matchWins / total) * 100).toFixed(1) : '0.0';
                                    return `
                                        <tr class="hover:bg-slate-50">
                                            <td class="px-4 py-3 font-semibold">${p.name}</td>
                                            <td class="px-4 py-3 text-slate-600">${p.team}</td>
                                            <td class="px-4 py-3 text-center">${p.matchWins}</td>
                                            <td class="px-4 py-3 text-center">${p.matchLosses}</td>
                                            <td class="px-4 py-3 text-center">${p.gamesWon}</td>
                                            <td class="px-4 py-3 text-center">${p.gamesLost}</td>
                                            <td class="px-4 py-3 text-center font-bold text-emerald-700">${pct}%</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function renderHistory() {
            const completed = state.schedule
                .filter(s => !s.isBye && state.matches.find(m => m.scheduleId === s.id))
                .sort((a, b) => new Date(b.date) - new Date(a.date));

            return `
                <div class="space-y-6">
                    <div class="bg-gradient-to-r from-emerald-600 to-teal-600 text-white rounded-xl shadow-lg p-6">
                        <h2 class="text-3xl font-black">üìú Match History</h2>
                    </div>

                    ${completed.length === 0 ? `
                        <div class="bg-white rounded-xl shadow-lg p-12 text-center">
                            <p class="text-slate-600">No completed matches yet</p>
                        </div>
                    ` : completed.map(sched => {
                        const match = state.matches.find(m => m.scheduleId === sched.id);
                        const home = state.teams.find(t => t.id === sched.homeTeamId);
                        const away = state.teams.find(t => t.id === sched.awayTeamId);
                        return `
                            <div class="bg-white rounded-xl shadow-lg p-6">
                                <div class="flex justify-between items-center">
                                    <div>
                                        <h3 class="text-xl font-bold">${away?.name} @ ${home?.name}</h3>
                                        <p class="text-slate-600">Week ${sched.week} ‚Ä¢ ${sched.date} ‚Ä¢ ${sched.venue}</p>
                                    </div>
                                    <div class="text-3xl font-black text-emerald-700">
                                        ${match.awayScore} - ${match.homeScore}
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        function renderTeams() {
            const isAdmin = state.currentUser.role === 'admin';
            const isCaptain = state.currentUser.role === 'captain';
            const myTeamId = state.currentUser.teamId;

            return `
                <div class="space-y-6">
                    <div class="bg-gradient-to-r from-emerald-600 to-teal-600 text-white rounded-xl shadow-lg p-6">
                        <h2 class="text-3xl font-black">üè† Teams</h2>
                    </div>

                    ${isAdmin ? `
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <button onclick="state.showCreateTeam = !state.showCreateTeam; render();" class="w-full bg-emerald-600 text-white font-bold py-3 rounded-lg hover:bg-emerald-700">
                            √¢≈æ‚Ä¢ Create New Team
                        </button>
                        ${state.showCreateTeam ? `
                        <div class="mt-4 space-y-3 border-t pt-4">
                            <input type="text" id="team-name" placeholder="Team Name" class="w-full px-4 py-2 border-2 rounded-lg">
                            <input type="text" id="team-venue" placeholder="Home Venue" class="w-full px-4 py-2 border-2 rounded-lg">
                            <input type="text" id="team-captain" placeholder="Captain Name" class="w-full px-4 py-2 border-2 rounded-lg">
                            <input type="tel" id="team-phone" placeholder="Captain Phone" class="w-full px-4 py-2 border-2 rounded-lg">
                            <button onclick="handleCreateTeam()" class="w-full bg-blue-600 text-white font-bold py-2 rounded-lg">Create</button>
                        </div>
                        ` : ''}
                    </div>
                    ` : ''}

                    ${state.teams.map(team => {
                        const canEdit = isAdmin || (isCaptain && myTeamId === team.id);
                        const isMyTeam = myTeamId === team.id;
                        return `
                        <div class="bg-white rounded-xl shadow-lg p-6 border-2 ${isMyTeam ? 'border-emerald-400 bg-emerald-50' : 'border-slate-200'}">
                            <div class="flex justify-between items-start mb-4">
                                <div>
                                    <h3 class="text-2xl font-bold flex items-center gap-2">
                                        ${team.name}
                                        ${isMyTeam ? '<span class="text-sm bg-emerald-600 text-white px-2 py-1 rounded-full">Your Team</span>' : ''}
                                    </h3>
                                    <p class="text-slate-600">üìç ${team.venue || 'No venue'} ‚Ä¢ üë§ ${team.captain || 'No captain'}</p>
                                </div>
                                ${isAdmin ? `<button onclick="deleteTeam('${team.id}')" class="text-red-600 hover:bg-red-50 p-2 rounded">√¢¬ù≈í</button>` : ''}
                            </div>
                            <div class="border-t pt-4">
                                <h4 class="font-bold mb-2">Players (${team.players.length})</h4>
                                <div class="grid sm:grid-cols-2 gap-2 mb-4">
                                    ${team.players.map(p => `
                                        <div class="flex justify-between items-center bg-slate-50 p-2 rounded border">
                                            <span>${p.name}</span>
                                            ${canEdit ? `<button onclick="removePlayer('${team.id}', '${p.id}')" class="text-red-600 text-sm">√¢¬ù≈í</button>` : ''}
                                        </div>
                                    `).join('')}
                                </div>
                                ${canEdit ? `
                                <div class="flex gap-2">
                                    <input type="text" id="player-${team.id}" placeholder="New player name" class="flex-1 px-3 py-2 border rounded">
                                    <button onclick="handleAddPlayer('${team.id}')" class="px-4 py-2 bg-blue-600 text-white rounded font-bold">Add</button>
                                </div>
                                <p class="text-xs text-slate-500 mt-1">üí° Adding a player creates a user account</p>
                                ` : ''}
                            </div>
                        </div>
                    `}).join('')}
                </div>
            `;
        }

        function renderUsers() {
            const isAdmin = state.currentUser.role === 'admin';
            return `
                <div class="space-y-6">
                    <div class="bg-gradient-to-r from-emerald-600 to-teal-600 text-white rounded-xl shadow-lg p-6">
                        <h2 class="text-3xl font-black">üë• User Management</h2>
                    </div>

                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <button onclick="document.getElementById('create-user-form').classList.toggle('hidden')" class="w-full bg-emerald-600 text-white font-bold py-3 rounded-lg hover:bg-emerald-700">
                            √¢≈æ‚Ä¢ Create New User
                        </button>
                        <div id="create-user-form" class="hidden mt-4 space-y-3 border-t pt-4">
                            <input type="text" id="new-username" placeholder="Username" class="w-full px-4 py-2 border-2 rounded-lg">
                            <input type="password" id="new-password" placeholder="Password" class="w-full px-4 py-2 border-2 rounded-lg">
                            <input type="tel" id="new-phone" placeholder="Phone" class="w-full px-4 py-2 border-2 rounded-lg">
                            ${isAdmin ? `<select id="new-role" class="w-full px-4 py-2 border-2 rounded-lg"><option value="captain">Captain</option><option value="admin">Admin</option></select>` : ''}
                            <button onclick="handleCreateUser()" class="w-full bg-blue-600 text-white font-bold py-2 rounded-lg">Create</button>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl shadow-lg divide-y">
                        ${state.users.map(user => {
                            const team = state.teams.find(t => t.id === user.teamId);
                            return `
                            <div class="p-4 flex items-center gap-4 ${user.id === state.currentUser.id ? 'bg-emerald-50' : ''}">
                                <div class="text-3xl">${user.role === 'admin' ? 'üõ°Ô∏è' : 'üë§'}</div>
                                <div class="flex-1">
                                    <div class="font-bold">${user.username} ${user.id === state.currentUser.id ? '<span class="text-xs bg-emerald-600 text-white px-2 py-0.5 rounded-full">You</span>' : ''}</div>
                                    <div class="text-sm text-slate-600">${user.role} ${team ? '‚Ä¢ ' + team.name : ''}</div>
                                    <div class="text-sm">üì± ${user.phone || 'No phone'}</div>
                                </div>
                                ${isAdmin && user.id !== state.currentUser.id ? `
                                    <select onchange="assignTeam('${user.id}', this.value)" class="px-2 py-1 border rounded text-sm">
                                        <option value="">No team</option>
                                        ${state.teams.map(t => `<option value="${t.id}" ${user.teamId === t.id ? 'selected' : ''}>${t.name}</option>`).join('')}
                                    </select>
                                    <button onclick="deleteUser('${user.id}')" class="px-3 py-1 bg-red-600 text-white rounded text-sm">Delete</button>
                                ` : ''}
                            </div>
                        `}).join('')}
                    </div>
                </div>
            `;
        }

        function renderAdmin() {
            const conflicts = [];
            const grouped = {};
            state.submissions.forEach(s => {
                if (!grouped[s.scheduleId]) grouped[s.scheduleId] = [];
                grouped[s.scheduleId].push(s);
            });
            Object.entries(grouped).forEach(([schedId, subs]) => {
                if (subs.length === 2 && (subs[0].homeScore !== subs[1].homeScore || subs[0].awayScore !== subs[1].awayScore)) {
                    conflicts.push({ scheduleId: schedId, submissions: subs });
                }
            });

            return `
                <div class="space-y-6">
                    <div class="bg-gradient-to-r from-emerald-600 to-teal-600 text-white rounded-xl shadow-lg p-6">
                        <h2 class="text-3xl font-black">üõ°Ô∏è Admin Panel</h2>
                    </div>

                    <div class="grid md:grid-cols-3 gap-4">
                        <div class="bg-white rounded-xl shadow-lg p-6 text-center">
                            <div class="text-4xl font-black text-blue-600">${state.users.length}</div>
                            <div class="text-slate-600">Users</div>
                        </div>
                        <div class="bg-white rounded-xl shadow-lg p-6 text-center">
                            <div class="text-4xl font-black text-emerald-600">${state.teams.length}</div>
                            <div class="text-slate-600">Teams</div>
                        </div>
                        <div class="bg-white rounded-xl shadow-lg p-6 text-center">
                            <div class="text-4xl font-black text-purple-600">${state.matches.length}</div>
                            <div class="text-slate-600">Completed Matches</div>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h3 class="text-xl font-bold mb-4">‚ö†Ô∏è Score Conflicts (${conflicts.length})</h3>
                        ${conflicts.length === 0 ? '<p class="text-slate-600">No conflicts to resolve</p>' : 
                            conflicts.map(c => {
                                const sched = state.schedule.find(s => s.id === c.scheduleId);
                                const home = state.teams.find(t => t.id === sched?.homeTeamId);
                                const away = state.teams.find(t => t.id === sched?.awayTeamId);
                                return `
                                    <div class="border-2 border-red-200 rounded-lg p-4 mb-4 bg-red-50">
                                        <h4 class="font-bold">Week ${sched?.week}: ${away?.name} @ ${home?.name}</h4>
                                        <div class="grid grid-cols-2 gap-4 mt-2">
                                            ${c.submissions.map((sub, i) => {
                                                const team = state.teams.find(t => t.id === sub.teamId);
                                                return `
                                                    <div class="bg-white p-3 rounded border">
                                                        <div class="font-semibold">${team?.name}'s submission:</div>
                                                        <div class="text-2xl font-bold">${sub.awayScore} - ${sub.homeScore}</div>
                                                        <button onclick="approveSubmission('${c.scheduleId}', ${i})" class="mt-2 px-3 py-1 bg-emerald-600 text-white rounded text-sm">Approve This</button>
                                                    </div>
                                                `;
                                            }).join('')}
                                        </div>
                                        <button onclick="rejectBoth('${c.scheduleId}')" class="mt-3 px-4 py-2 bg-red-600 text-white rounded w-full">Reject Both - Require Resubmit</button>
                                    </div>
                                `;
                            }).join('')
                        }
                    </div>

                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h3 class="text-xl font-bold mb-4">üîß Actions</h3>
                        <button onclick="if(confirm('Clear ALL data?')) { localStorage.clear(); location.reload(); }" class="w-full bg-red-600 text-white font-bold py-3 rounded-lg">
                            üóëÔ∏è Clear All Data
                        </button>
                    </div>
                </div>
            `;
        }

        function renderSettings() {
            return `
                <div class="space-y-6">
                    <div class="bg-gradient-to-r from-emerald-600 to-teal-600 text-white rounded-xl shadow-lg p-6">
                        <h2 class="text-3xl font-black">‚öôÔ∏è Settings</h2>
                    </div>
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <label class="block text-sm font-bold mb-2">League Name</label>
                        <input type="text" id="league-name" value="${state.leagueName}" class="w-full px-4 py-2 border-2 rounded-lg mb-4">
                        <button onclick="handleSaveSettings()" class="w-full bg-emerald-600 text-white font-bold py-3 rounded-lg">Save Settings</button>
                    </div>
                </div>
            `;
        }

        // Event handlers
        window.handleLogin = function() {
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;
            const phoneInput = document.getElementById('login-phone');
            const phone = phoneInput ? phoneInput.value : '';
            if (state.users.length === 0) createAccount(username, password, phone);
            else if (!login(username, password)) {
                document.getElementById('login-error').textContent = 'Invalid credentials';
                document.getElementById('login-error').classList.remove('hidden');
            }
        };

        window.handleCreateUser = function() {
            const username = document.getElementById('new-username').value;
            const password = document.getElementById('new-password').value;
            const phone = document.getElementById('new-phone').value;
            const roleEl = document.getElementById('new-role');
            const role = roleEl ? roleEl.value : 'captain';
            if (createAccount(username, password, phone, role)) {
                document.getElementById('new-username').value = '';
                document.getElementById('new-password').value = '';
                document.getElementById('new-phone').value = '';
                document.getElementById('create-user-form').classList.add('hidden');
            }
        };

        window.handleCreateTeam = function() {
            createTeam(
                document.getElementById('team-name').value,
                document.getElementById('team-venue').value,
                document.getElementById('team-captain').value,
                document.getElementById('team-phone').value
            );
        };

        window.handleAddPlayer = function(teamId) {
            const input = document.getElementById(`player-${teamId}`);
            if (input.value.trim()) {
                addPlayer(teamId, input.value);
                input.value = '';
            }
        };

        window.handleSaveSettings = function() {
            saveLeagueName(document.getElementById('league-name').value);
            alert('Settings saved!');
        };

        window.approveSubmission = function(scheduleId, subIndex) {
            const subs = state.submissions.filter(s => s.scheduleId === scheduleId);
            const sub = subs[subIndex];
            const comp = { scheduleId, homeScore: sub.homeScore, awayScore: sub.awayScore, matchups: sub.matchups, approved: true, timestamp: new Date().toISOString() };
            saveMatches([...state.matches, comp]);
            saveSubmissions(state.submissions.filter(s => s.scheduleId !== scheduleId));
            alert('Approved!');
        };

        window.rejectBoth = function(scheduleId) {
            if (confirm('Reject both and require resubmission?')) {
                saveSubmissions(state.submissions.filter(s => s.scheduleId !== scheduleId));
                alert('Both submissions rejected. Teams can resubmit.');
            }
        };

        // Main render
        function render() {
            console.log('Render called. Schedule length:', state.schedule.length);
            const app = document.getElementById('app');
            if (!state.currentUser) {
                app.innerHTML = renderLoginScreen();
            } else {
                const tabs = {
                    schedule: renderSchedule,
                    submit: renderSubmitScores,
                    standings: renderStandings,
                    players: renderPlayerStats,
                    history: renderHistory,
                    teams: renderTeams,
                    users: renderUsers,
                    admin: renderAdmin,
                    settings: renderSettings
                };
                app.innerHTML = `
                    <div class="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100">
                        ${renderHeader()}
                        ${renderNav()}
                        <main class="max-w-7xl mx-auto px-4 py-6">${tabs[state.activeTab]?.() || ''}</main>
                    </div>
                `;
            }
        }

        render();
        console.log('App loaded!');
    </script>
</body>
</html>
