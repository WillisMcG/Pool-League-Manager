<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upgrade Your Plan - Pool League Manager</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://js.stripe.com/v3/"></script>
    
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #064e3b 0%, #0f766e 50%, #115e59 100%);
        }
        .plan-card {
            transition: all 0.3s ease;
        }
        .plan-card:hover {
            transform: translateY(-4px);
        }
        .plan-card.selected {
            border-color: #059669;
            box-shadow: 0 0 0 3px rgba(5, 150, 105, 0.2);
        }
    </style>
</head>
<body class="bg-slate-100 min-h-screen">
    <!-- Header -->
    <header class="gradient-bg text-white py-6 px-4">
        <div class="max-w-4xl mx-auto flex items-center justify-between">
            <a href="app.html" class="flex items-center gap-2">
                <span class="text-2xl">üé±</span>
                <span class="text-xl font-bold">Pool League Manager</span>
            </a>
            <a href="app.html" class="text-emerald-200 hover:text-white">‚Üê Back to App</a>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-4xl mx-auto px-4 py-12">
        <!-- Trial Banner (shown if on trial) -->
        <div id="trial-banner" class="hidden bg-yellow-50 border-2 border-yellow-300 rounded-xl p-6 mb-8">
            <div class="flex items-start gap-4">
                <div class="text-3xl">‚è∞</div>
                <div>
                    <h2 class="font-bold text-yellow-800 text-lg">Your free trial <span id="trial-status"></span></h2>
                    <p class="text-yellow-700 mt-1" id="trial-message"></p>
                </div>
            </div>
        </div>

        <!-- Current Plan Banner (shown if already subscribed) -->
        <div id="subscribed-banner" class="hidden bg-emerald-50 border-2 border-emerald-300 rounded-xl p-6 mb-8">
            <div class="flex items-start gap-4">
                <div class="text-3xl">‚úÖ</div>
                <div>
                    <h2 class="font-bold text-emerald-800 text-lg">You're on the <span id="current-plan" class="capitalize"></span> plan</h2>
                    <p class="text-emerald-700 mt-1">Your subscription is active. Thank you for supporting Pool League Manager!</p>
                    <button onclick="manageBilling()" class="mt-3 px-4 py-2 bg-emerald-600 text-white rounded-lg font-semibold hover:bg-emerald-700">
                        Manage Billing ‚Üí
                    </button>
                </div>
            </div>
        </div>

        <!-- Not Logged In Banner -->
        <div id="login-banner" class="hidden bg-slate-50 border-2 border-slate-300 rounded-xl p-6 mb-8 text-center">
            <div class="text-4xl mb-4">üîí</div>
            <h2 class="font-bold text-slate-800 text-lg">Please sign in to upgrade</h2>
            <p class="text-slate-600 mt-1 mb-4">You need to be logged in to manage your subscription.</p>
            <a href="app.html" class="inline-block px-6 py-3 bg-emerald-600 text-white rounded-lg font-bold hover:bg-emerald-700">
                Sign In ‚Üí
            </a>
        </div>

        <!-- Pricing Section -->
        <div id="pricing-section" class="hidden">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-black text-slate-800 mb-2">Choose Your Plan</h1>
                <p class="text-slate-600">Unlock the full power of Pool League Manager</p>
            </div>

            <!-- Billing Toggle -->
            <div class="flex justify-center mb-8">
                <div class="bg-white rounded-full p-1 shadow-md inline-flex">
                    <button id="btn-monthly" onclick="setBilling('monthly')" 
                        class="px-6 py-2 rounded-full font-semibold transition-colors">
                        Monthly
                    </button>
                    <button id="btn-annual" onclick="setBilling('annual')" 
                        class="px-6 py-2 rounded-full font-semibold transition-colors">
                        Annual <span class="text-emerald-600 text-sm">(Save 10%)</span>
                    </button>
                </div>
            </div>

            <!-- Plan Cards -->
            <div class="grid md:grid-cols-2 gap-6 mb-8">
                <!-- Starter Plan -->
                <div id="card-starter" onclick="selectPlan('starter')" 
                    class="plan-card bg-white rounded-2xl p-8 border-2 border-slate-200 cursor-pointer">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="text-2xl font-bold text-slate-800">Starter</h3>
                            <p class="text-slate-500">For small leagues</p>
                        </div>
                        <div id="starter-check" class="hidden w-8 h-8 bg-emerald-500 rounded-full flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path>
                            </svg>
                        </div>
                    </div>
                    <div class="mb-6">
                        <span id="starter-price" class="text-4xl font-black text-slate-800">$19</span>
                        <span id="starter-interval" class="text-slate-500">/month</span>
                    </div>
                    <ul class="space-y-3 text-slate-600">
                        <li class="flex items-center gap-2">
                            <span class="text-emerald-500">‚úì</span> Up to 12 teams
                        </li>
                        <li class="flex items-center gap-2">
                            <span class="text-emerald-500">‚úì</span> Up to 100 players
                        </li>
                        <li class="flex items-center gap-2">
                            <span class="text-emerald-500">‚úì</span> 10 seasons of history
                        </li>
                        <li class="flex items-center gap-2">
                            <span class="text-emerald-500">‚úì</span> Auto schedule generation
                        </li>
                        <li class="flex items-center gap-2">
                            <span class="text-emerald-500">‚úì</span> Email support
                        </li>
                    </ul>
                </div>

                <!-- Pro Plan -->
                <div id="card-pro" onclick="selectPlan('pro')" 
                    class="plan-card bg-white rounded-2xl p-8 border-2 border-slate-200 cursor-pointer relative">
                    <div class="absolute -top-3 left-1/2 transform -translate-x-1/2">
                        <span class="bg-emerald-500 text-white px-3 py-1 rounded-full text-sm font-bold">RECOMMENDED</span>
                    </div>
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="text-2xl font-bold text-slate-800">Pro</h3>
                            <p class="text-slate-500">For growing leagues</p>
                        </div>
                        <div id="pro-check" class="hidden w-8 h-8 bg-emerald-500 rounded-full flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path>
                            </svg>
                        </div>
                    </div>
                    <div class="mb-6">
                        <span id="pro-price" class="text-4xl font-black text-slate-800">$39</span>
                        <span id="pro-interval" class="text-slate-500">/month</span>
                    </div>
                    <ul class="space-y-3 text-slate-600">
                        <li class="flex items-center gap-2">
                            <span class="text-emerald-500">‚úì</span> Up to 50 teams
                        </li>
                        <li class="flex items-center gap-2">
                            <span class="text-emerald-500">‚úì</span> Up to 500 players
                        </li>
                        <li class="flex items-center gap-2">
                            <span class="text-emerald-500">‚úì</span> 50 seasons of history
                        </li>
                        <li class="flex items-center gap-2">
                            <span class="text-emerald-500">‚úì</span> Everything in Starter
                        </li>
                        <li class="flex items-center gap-2">
                            <span class="text-emerald-500">‚úì</span> Priority support
                        </li>
                    </ul>
                </div>
            </div>

            <!-- Checkout Button -->
            <div class="text-center">
                <button id="checkout-btn" onclick="checkout()" disabled
                    class="px-12 py-4 bg-emerald-600 text-white font-bold text-lg rounded-xl hover:bg-emerald-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                    Select a plan to continue
                </button>
                <p class="text-slate-500 text-sm mt-4">
                    üîí Secure checkout powered by Stripe
                </p>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="text-center text-slate-500 text-sm py-8">
        <p>Questions? Contact us at support@poolleaguemanager.com</p>
    </footer>

    <script>
        // ============================================
        // CONFIGURATION
        // ============================================
        const SUPABASE_URL = 'https://hprdhlletatixqysqegi.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhwcmRobGxldGF0aXhxeXNxZWdpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgwOTU1NDMsImV4cCI6MjA4MzY3MTU0M30._wrv6ONjG3JRkpA1FDPFkKMSn0bi6vhMiR0UZB40IRk';
        const STRIPE_PUBLISHABLE_KEY = 'pk_test_51SoTE2DEuvjooNQ2C04FBdpjw5Drt66KyhFwa2I2mm0ml9a9l3fb5oO5BBpaDOBzQNtxYy90DAFpgRFBXxMz1vuQ003ScT41Nj';
        
        // Stripe Price IDs
        const PRICE_IDS = {
            starter: {
                monthly: 'price_1SoTI0DEuvjooNQ2Nonqm05j',
                annual: 'price_1SoTIWDEuvjooNQ2ccqt3rDa'
            },
            pro: {
                monthly: 'price_1SoTSEDEuvjooNQ22hx7yVb1',
                annual: 'price_1SoTSeDEuvjooNQ28XV4iKDm'
            }
        };

        const PRICES = {
            starter: { monthly: 19, annual: 205 },
            pro: { monthly: 39, annual: 421 }
        };

        // Initialize clients
        const db = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        const stripe = Stripe(STRIPE_PUBLISHABLE_KEY);

        // State
        let currentUser = null;
        let currentOrg = null;
        let selectedPlan = null;
        let billingInterval = 'monthly';

        // ============================================
        // INITIALIZATION
        // ============================================
        async function init() {
            // Check for logged in user
            const session = localStorage.getItem('plm_session');
            if (!session) {
                showLoginBanner();
                return;
            }

            try {
                const { id } = JSON.parse(session);
                
                // Load user
                const { data: userData, error: userError } = await db.from('users')
                    .select('*')
                    .eq('id', id)
                    .single();
                
                if (userError || !userData) {
                    showLoginBanner();
                    return;
                }
                
                currentUser = userData;

                // Load organization
                if (userData.org_id) {
                    const { data: orgData, error: orgError } = await db.from('organizations')
                        .select('*')
                        .eq('id', userData.org_id)
                        .single();
                    
                    if (orgData) {
                        currentOrg = orgData;
                        
                        // Check subscription status
                        if (orgData.subscription_status === 'active') {
                            showSubscribedBanner(orgData.subscription_tier);
                        } else if (orgData.subscription_status === 'trial') {
                            showTrialBanner(orgData.trial_ends_at);
                            showPricingSection();
                        } else {
                            // Expired or canceled
                            showTrialBanner(orgData.trial_ends_at, true);
                            showPricingSection();
                        }
                    }
                }
            } catch (e) {
                console.error('Init error:', e);
                showLoginBanner();
            }
        }

        // ============================================
        // UI FUNCTIONS
        // ============================================
        function showLoginBanner() {
            document.getElementById('login-banner').classList.remove('hidden');
        }

        function showTrialBanner(trialEndsAt, expired = false) {
            const banner = document.getElementById('trial-banner');
            const status = document.getElementById('trial-status');
            const message = document.getElementById('trial-message');
            
            const endDate = new Date(trialEndsAt);
            const now = new Date();
            const daysLeft = Math.ceil((endDate - now) / (1000 * 60 * 60 * 24));
            
            if (expired || daysLeft <= 0) {
                status.textContent = 'has expired';
                message.textContent = 'Upgrade now to continue using Pool League Manager.';
                banner.classList.remove('bg-yellow-50', 'border-yellow-300');
                banner.classList.add('bg-red-50', 'border-red-300');
                status.classList.add('text-red-800');
            } else if (daysLeft <= 3) {
                status.textContent = `expires in ${daysLeft} day${daysLeft === 1 ? '' : 's'}`;
                message.textContent = 'Upgrade now to avoid any interruption to your service.';
            } else {
                status.textContent = `has ${daysLeft} days remaining`;
                message.textContent = 'Upgrade anytime to unlock your full potential.';
            }
            
            banner.classList.remove('hidden');
        }

        function showSubscribedBanner(tier) {
            document.getElementById('current-plan').textContent = tier;
            document.getElementById('subscribed-banner').classList.remove('hidden');
            // Still show pricing section for upgrades/downgrades
            document.getElementById('pricing-section').classList.remove('hidden');
        }

        function showPricingSection() {
            document.getElementById('pricing-section').classList.remove('hidden');
            setBilling('monthly');
        }

        function setBilling(interval) {
            billingInterval = interval;
            
            // Update toggle buttons
            const btnMonthly = document.getElementById('btn-monthly');
            const btnAnnual = document.getElementById('btn-annual');
            
            if (interval === 'monthly') {
                btnMonthly.classList.add('bg-emerald-600', 'text-white');
                btnMonthly.classList.remove('text-slate-600');
                btnAnnual.classList.remove('bg-emerald-600', 'text-white');
                btnAnnual.classList.add('text-slate-600');
            } else {
                btnAnnual.classList.add('bg-emerald-600', 'text-white');
                btnAnnual.classList.remove('text-slate-600');
                btnMonthly.classList.remove('bg-emerald-600', 'text-white');
                btnMonthly.classList.add('text-slate-600');
            }
            
            // Update prices
            document.getElementById('starter-price').textContent = '$' + PRICES.starter[interval];
            document.getElementById('starter-interval').textContent = interval === 'monthly' ? '/month' : '/year';
            document.getElementById('pro-price').textContent = '$' + PRICES.pro[interval];
            document.getElementById('pro-interval').textContent = interval === 'monthly' ? '/month' : '/year';
            
            updateCheckoutButton();
        }

        function selectPlan(plan) {
            selectedPlan = plan;
            
            // Update card styles
            const starterCard = document.getElementById('card-starter');
            const proCard = document.getElementById('card-pro');
            const starterCheck = document.getElementById('starter-check');
            const proCheck = document.getElementById('pro-check');
            
            starterCard.classList.remove('selected', 'border-emerald-500');
            proCard.classList.remove('selected', 'border-emerald-500');
            starterCheck.classList.add('hidden');
            proCheck.classList.add('hidden');
            
            if (plan === 'starter') {
                starterCard.classList.add('selected', 'border-emerald-500');
                starterCheck.classList.remove('hidden');
                starterCheck.classList.add('flex');
            } else {
                proCard.classList.add('selected', 'border-emerald-500');
                proCheck.classList.remove('hidden');
                proCheck.classList.add('flex');
            }
            
            updateCheckoutButton();
        }

        function updateCheckoutButton() {
            const btn = document.getElementById('checkout-btn');
            
            if (selectedPlan) {
                const price = PRICES[selectedPlan][billingInterval];
                const interval = billingInterval === 'monthly' ? 'mo' : 'yr';
                btn.textContent = `Upgrade to ${selectedPlan.charAt(0).toUpperCase() + selectedPlan.slice(1)} - $${price}/${interval}`;
                btn.disabled = false;
            } else {
                btn.textContent = 'Select a plan to continue';
                btn.disabled = true;
            }
        }

        // ============================================
        // CHECKOUT
        // ============================================
        
        // Stripe Payment Links
        const PAYMENT_LINKS = {
            starter: {
                monthly: 'https://buy.stripe.com/test_28E9ATeWRf1y4UVfoPdjO01',
                annual: 'https://buy.stripe.com/test_4gMbJ13e97z65YZa4vdjO02'
            },
            pro: {
                monthly: 'https://buy.stripe.com/test_4gMeVdbKFdXudrrgsTdjO03',
                annual: 'https://buy.stripe.com/test_3cI5kDdSN9Hebjj0tVdjO04'
            }
        };
        
        async function checkout() {
            if (!selectedPlan || !currentUser || !currentOrg) {
                alert('Please select a plan');
                return;
            }

            const btn = document.getElementById('checkout-btn');
            btn.disabled = true;
            btn.textContent = 'Redirecting to checkout...';

            try {
                // Get the payment link for selected plan and billing interval
                const paymentLink = PAYMENT_LINKS[selectedPlan][billingInterval];
                
                // Add client_reference_id to track which org is paying
                const checkoutUrl = paymentLink + '?client_reference_id=' + currentOrg.id + '&prefilled_email=' + encodeURIComponent(currentUser.username);
                
                // Redirect to Stripe Payment Link
                window.location.href = checkoutUrl;
                
            } catch (error) {
                console.error('Checkout error:', error);
                alert('Error starting checkout: ' + error.message);
                btn.disabled = false;
                updateCheckoutButton();
            }
        }

        async function manageBilling() {
            // In production, this would redirect to Stripe Customer Portal
            // For now, show a message
            alert('Billing management coming soon!\n\nTo manage your subscription, contact support@poolleaguemanager.com');
        }

        // ============================================
        // INIT
        // ============================================
        init();
    </script>
</body>
</html>
